# 单词发音问题解决方案

## 问题描述

在词汇训练应用中，部分单词（如 "thief"、"woman"、"dare" 等）的美音发音错误，被发音为 "horoscope"。

## 问题原因

经过调查，发现以下几个问题：

1. **数据库中缺少美音路径**：通过检查数据库，发现有大量单词（约4798个）缺少美音音频路径（`audio_path_us`字段为空）。

2. **音频文件不存在**：即使数据库中有音频路径，但实际文件可能不存在，导致播放失败。

3. **TTS回退机制问题**：当本地音频文件不存在或播放失败时，系统会尝试使用TTS（文本转语音）作为备选方案。但TTS生成的音频可能存在发音问题，或者TTS缓存中的文件与预期不符。

## 解决方案

### 1. 为缺少美音的单词生成TTS音频

我们创建了两个脚本来解决这个问题：

- `fix_audio_paths.py`：检查特定单词的音频路径，并为缺少美音的单词生成TTS音频。
- `fix_all_audio_paths.py`：批量处理所有缺少美音的单词，生成TTS音频并更新数据库。

### 2. 使用方法

#### 修复特定单词

```bash
python fix_audio_paths.py
```

这将检查并修复 "thief"、"woman"、"dare"、"horoscope" 等特定单词的美音路径。

#### 修复所有单词

```bash
python fix_all_audio_paths.py
```

这将批量处理所有缺少美音的单词（约4798个），为每个单词生成TTS音频并更新数据库。

### 3. 长期解决方案

为了从根本上解决这个问题，建议：

1. **完善音频资源**：获取更完整的单词音频资源，确保每个单词都有对应的英音和美音文件。

2. **改进TTS机制**：
   - 使用更高质量的TTS服务，如Google Cloud TTS、Amazon Polly等。
   - 为特殊单词添加发音指南，避免发音错误。

3. **增强错误处理**：
   - 在音频播放失败时提供更明确的错误信息。
   - 建立音频资源检查机制，定期验证音频文件的完整性。

4. **用户反馈机制**：允许用户报告发音错误，以便及时修复。

## 技术细节

### 音频播放流程

当前系统的音频播放流程如下：

1. 首先尝试播放英音（`audio_path_uk`）
2. 然后尝试播放美音（`audio_path_us`）
3. 如果音频文件不存在或播放失败，尝试使用后端TTS API生成音频
4. 如果后端TTS失败，使用浏览器内置的TTS功能

### TTS音频缓存

系统使用gTTS库生成TTS音频，并将其缓存在 `wordlists/tts_cache` 目录中。文件名使用单词的MD5哈希值，以避免文件名问题。

### 数据库更新

修复脚本会将生成的TTS音频路径更新到数据库的 `audio_path_us` 字段中，格式为：

```
/wordlists/tts_cache/{md5_hash}.mp3
```

## 注意事项

1. 批量处理所有单词可能需要较长时间，建议在非高峰期进行。
2. TTS生成的音频质量可能不如专业录制的音频，但可以作为临时解决方案。
3. 如果发现特定单词的TTS发音仍有问题，可以手动录制或获取该单词的音频文件，并更新数据库中的路径。