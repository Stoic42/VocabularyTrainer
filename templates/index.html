<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lumi Vocabulary Trainer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* æ‚¨ç¼–å†™çš„æ‰€æœ‰ç²¾ç¾CSSæ ·å¼ï¼Œæˆ‘ä»¬å®Œå…¨ä¿ç•™ */
        :root {
            --primary-color: #FFB347; /* æ˜äº®çš„æ©™é»„è‰² */
            --hover-color: #FF9F1C;   /* æ·±æ©™è‰² */
            --error-color: #4f2b4b;    /* æ·±ç´«è‰² */
            --text-color: #2D3436;     /* æ›´æ·±çš„æ–‡å­—é¢œè‰² */
            --bg-color: #FFF8E7;       /* æ¸©æš–çš„ç±³è‰²èƒŒæ™¯ */
            --accent-color: #FF7B54;   /* æ´»åŠ›çŠç‘šæ©™ */
            --border-radius: 8px;
        }
        
        /* è®¤è¯è¡¨å•æ ·å¼ */
        .auth-form {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            transition: all 0.3s ease;
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--text-color);
            font-size: 1.8em;
            font-weight: 600;
            position: relative;
        }
        
        .auth-form h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background-color: var(--primary-color);
            border-radius: 3px;
        }
        
        .auth-input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            font-size: 1em;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 179, 71, 0.2);
        }
        
        .auth-button {
            width: 100%;
            margin-bottom: 10px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .auth-button:hover {
            background-color: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .auth-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .auth-button::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: -100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s ease;
        }
        
        .auth-button:hover::after {
            left: 100%;
        }
        
        .auth-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            position: relative;
            padding-bottom: 2px;
            transition: all 0.3s ease;
        }
        
        .auth-link:hover {
            color: var(--hover-color);
        }
        
        .auth-link::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 0;
            background-color: var(--hover-color);
            transition: width 0.3s ease;
        }
        
        .auth-link:hover::after {
            width: 100%;
        }
        
        .auth-error {
            color: var(--error-color);
            font-size: 0.9em;
            margin-bottom: 15px;
            display: none;
            padding: 8px;
            border-radius: var(--border-radius);
            background-color: rgba(220, 53, 69, 0.1);
            border-left: 3px solid var(--error-color);
            transition: all 0.3s ease;
        }
        
        .auth-notification {
            color: var(--success-color);
            font-size: 0.9em;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: var(--border-radius);
            background-color: rgba(40, 167, 69, 0.1);
            border-left: 3px solid var(--success-color);
            text-align: center;
            animation: fadeIn 0.5s ease;
            transition: opacity 0.5s ease;
        }
        
        @media (max-width: 480px) {
            .auth-link {
                display: inline-block;
                margin-top: 5px;
                font-size: 1.1em;
            }
            
            .auth-form {
                padding: 20px;
            }
        }
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            font-family: 'Noto Sans SC', system-ui, sans-serif;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: var(--text-color); line-height: 1.6; overflow-x: hidden;
            position: relative;
        }
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('/assets/img/Logo/orange-theme-logo.svg');
            background-size: 200px;
            background-repeat: repeat;
            opacity: 0.05;
            z-index: -1;
        }
        #app-container {
            max-width: 800px; margin: 40px auto; padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            position: relative; backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .header { text-align: center; margin-bottom: 30px; }
        button, .btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 10px 20px; border-radius: var(--border-radius); cursor: pointer;
            transition: all 0.3s ease; font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:hover, .btn:hover {
            background-color: var(--hover-color); transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn { text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        #play-uk-btn, #play-us-btn {
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0 5px; padding: 8px 15px; font-size: 0.9em;
        }
        input[type="text"] {
            width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #e9ecef;
            border-radius: var(--border-radius); font-size: 1em;
            transition: border-color 0.3s ease; box-sizing: border-box;
        }
        input[type="text"]:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255,179,71,0.1);
        }
        #quiz-area, #results-area { 
            margin-top: 20px; padding: 20px; border-radius: var(--border-radius); 
            background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
        }
        #quiz-area {
            border: 3px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(255, 179, 71, 0.2);
            position: relative;
        }
        
        /* å³ä¸‹è§’æ§åˆ¶æŒ‰é’®æ ·å¼ */
        .quiz-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 100;
            opacity: 0.3;
            transition: opacity 0.3s ease;
        }
        .quiz-controls:hover { opacity: 1; }
        .control-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .control-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 179, 71, 0.3);
        }
        .control-btn:active { transform: scale(0.95); }
        .control-btn::after {
            content: attr(title);
            position: absolute;
            right: 50px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }
        .control-btn:hover::after { opacity: 1; }
        .control-btn::before {
            content: '';
            position: absolute;
            right: 45px;
            top: 50%;
            transform: translateY(-50%);
            border: 4px solid transparent;
            border-left-color: rgba(0, 0, 0, 0.8);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .control-btn:hover::before { opacity: 1; }
        #results-area { display: none; }
        #error-list { list-style-type: none; padding-left: 0; }
        #error-list li { margin: 10px 0; padding: 10px; background: #fff5f5; border-radius: var(--border-radius); border-left: 4px solid var(--error-color); }
        
        /* æ‹¼å†™å˜ä½“æ ·å¼ */
        .spelling-variant {
            display: inline-block;
            padding: 2px 6px;
            margin: 0 2px;
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 3px;
            font-weight: bold;
        }
        
        /* æ‹¼å†™æç¤ºæ ·å¼ */
        .spelling-tip {
            animation: fadeInOut 3s ease-in-out;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; }
            10% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        .list-selector { margin: 20px 0; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .list-selector label { font-weight: 500; }
        select {
            min-width: 150px; padding: 10px 15px; border: 1px solid #ddd; border-radius: var(--border-radius);
            font-size: 16px; background-color: white; cursor: pointer;
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 16px;
        }
        .lumi-reaction {
            position: fixed; 
            bottom: 3vh; /* ä½¿ç”¨è§†å£é«˜åº¦çš„ç™¾åˆ†æ¯” */
            left: 50%;
            width: calc(min(20vh, 20vw, 200px)); /* æ ¹æ®è§†å£é«˜åº¦ã€å®½åº¦å’Œæœ€å¤§åƒç´ å€¼å–æœ€å°å€¼ */
            height: calc(min(20vh, 20vw, 200px)); /* ä¿æŒå®½é«˜æ¯”ä¾‹ä¸€è‡´ */
            transform: translateX(-50%);
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 9999; opacity: 1;
            background-size: contain; background-repeat: no-repeat; background-position: center;
            pointer-events: none;
        }
        
        /* å½“çª—å£é«˜åº¦è¾ƒä½æ—¶ï¼Œå°† Lumi ç§»åˆ°å³ä¸‹è§’ */
        .lumi-reaction.corner {
            left: auto;
            right: 2vw;
            bottom: 2vh;
            transform: none;
            width: calc(min(15vh, 15vw, 150px)); /* åœ¨è§’è½æ—¶ç¨å¾®ç¼©å° */
            height: calc(min(15vh, 15vw, 150px));
            opacity: 0.8; /* ç¨å¾®é™ä½é€æ˜åº¦ */
        }
        
        /* è§’è½æ¨¡å¼ä¸‹çš„åŠ¨ç”» */
        .lumi-reaction.corner.active { 
            animation: lumiFloatCorner 15s ease-in-out infinite alternate; 
        }
        .lumi-reaction.corner.bounce { 
            animation: lumiJumpCorner 0.5s cubic-bezier(0.36, 0, 0.66, -0.56) forwards !important; 
        }
        
        /* å½“çª—å£é«˜åº¦æä½æ—¶ï¼Œéšè— Lumi */
        .lumi-reaction.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .lumi-reaction.active { opacity: 1; animation: lumiFloat 15s ease-in-out infinite alternate; }
        .lumi-reaction.bounce { animation: lumiJump 0.5s cubic-bezier(0.36, 0, 0.66, -0.56) forwards !important; }
        /* ä¸­å¿ƒä½ç½®çš„åŠ¨ç”» */
        @keyframes lumiJump { 
            0% { transform: translateX(-50%) scale(1); } 
            50% { transform: translateX(-50%) scale(1.1) translateY(-1vh); } /* ä½¿ç”¨è§†å£é«˜åº¦çš„ç™¾åˆ†æ¯” */ 
            100% { transform: translateX(-50%) scale(1); } 
        }
        @keyframes lumiFloat { 
            0% { transform: translateX(-50%); } 
            25% { transform: translate(calc(-50% - 0.5vw), 0.5vh); } /* ä½¿ç”¨è§†å£å®½åº¦å’Œé«˜åº¦çš„ç™¾åˆ†æ¯” */ 
            50% { transform: translate(calc(-50% + 0.5vw), -0.5vh); } 
            75% { transform: translate(calc(-50% - 0.3vw), 0.3vh); } 
            100% { transform: translateX(-50%); } 
        }
        
        /* è§’è½ä½ç½®çš„åŠ¨ç”» */
        @keyframes lumiJumpCorner { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.1) translateY(-1vh); } 
            100% { transform: scale(1); } 
        }
        @keyframes lumiFloatCorner { 
            0% { transform: none; } 
            25% { transform: translate(-0.5vw, 0.5vh); } 
            50% { transform: translate(0.5vw, -0.5vh); } 
            75% { transform: translate(-0.3vw, 0.3vh); } 
            100% { transform: none; } 
        }
        
        /* å¼€å…³æŒ‰é’®æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 10px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .lumi-toggle-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="auth-container" style="max-width: 400px; margin: 40px auto; padding: 20px; background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius); box-shadow: 0 8px 32px rgba(0,0,0,0.2); position: relative; backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.3);">
        <div class="header">
            <div class="logo-container" style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                <img src="/assets/img/Logo/orange-theme-logo.svg" alt="çƒ›æ¢¦æ•™è‚²" style="height: 80px;">
            </div>
        </div>
        
        <div id="login-form" class="auth-form">
            <h2>ç”¨æˆ·ç™»å½•</h2>
            <div style="margin-bottom: 15px;">
                <label for="login-username">ç”¨æˆ·å:</label>
                <input type="text" id="login-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" class="auth-input">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="login-password">å¯†ç :</label>
                <input type="password" id="login-password" placeholder="è¯·è¾“å…¥å¯†ç " class="auth-input">
            </div>
            <div id="login-error" class="auth-error"></div>
            <button id="login-btn" class="auth-button">ç™»å½•</button>
            <p style="text-align: center; margin-top: 15px;">è¿˜æ²¡æœ‰è´¦å·? <a href="#" id="show-register" class="auth-link">ç«‹å³æ³¨å†Œ</a></p>
        </div>
        
        <div id="register-form" class="auth-form" style="display: none;">
            <h2>ç”¨æˆ·æ³¨å†Œ</h2>
            <div style="margin-bottom: 15px;">
                <label for="register-username">ç”¨æˆ·å:</label>
                <input type="text" id="register-username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" class="auth-input">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="register-password">å¯†ç :</label>
                <input type="password" id="register-password" placeholder="è¯·è¾“å…¥å¯†ç " class="auth-input">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="register-confirm-password">ç¡®è®¤å¯†ç :</label>
                <input type="password" id="register-confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " class="auth-input">
            </div>
            <div id="register-error" class="auth-error"></div>
            <button id="register-btn" class="auth-button">æ³¨å†Œ</button>
            <p style="text-align: center; margin-top: 15px;">å·²æœ‰è´¦å·? <a href="#" id="show-login" class="auth-link">è¿”å›ç™»å½•</a></p>
        </div>
    </div>
    
    <div id="app-container" style="display: none;">
        <div class="header">
            <div class="logo-container" style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                <img src="/assets/img/Logo/orange-theme-logo.svg" alt="çƒ›æ¢¦æ•™è‚²" style="height: 80px; margin-right: 15px;">
            </div>
            <h1>çƒ›æ¢¦å•è¯è€ƒæ ¸</h1>
            <div style="text-align: right; margin-top: -40px;">
                <span id="user-info" style="margin-right: 10px;"></span>
                <a href="#" id="logout-btn" style="color: var(--primary-color);">é€€å‡ºç™»å½•</a>
            </div>
        </div>

        <div class="list-selector">
            <div>
                <label for="book-select">é€‰æ‹©è¯ä¹¦: </label>
                <select id="book-select">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
            </div>
            <div>
                <label for="list-select">é€‰æ‹©å•å…ƒ: </label>
                <select id="list-select">
                    <option value="">è¯·å…ˆé€‰æ‹©è¯ä¹¦...</option>
                </select>
            </div>
            <div>
                <label for="count-select">é€‰æ‹©æ•°é‡: </label>
                <select id="count-select">
                    <option value="10">10ä¸ª</option>
                    <option value="20">20ä¸ª</option>
                    <option value="50">50ä¸ª</option>
                    <option value="all">å…¨éƒ¨</option>
                </select>
            </div>
            <div>
                <label for="study-mode">å­¦ä¹ æ¨¡å¼: </label>
                <select id="study-mode">
                    <option value="standard">æ ‡å‡†æ¨¡å¼</option>
                    <option value="dictation">é»˜å†™æ¨¡å¼</option>
                    <option value="error_review">é”™è¯å¤ä¹ æ¨¡å¼</option>
                </select>
            </div>
        </div>

        <!-- é”™è¯å¤ä¹ æ¨¡å¼ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="error-stats-container" style="display: none; margin-top: 15px; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
            <h3 style="margin: 0 0 10px 0; color: #856404;">é”™è¯å¤ä¹ ç»Ÿè®¡</h3>
            <div id="error-stats-content">
                <p>æ­£åœ¨åŠ è½½ç»Ÿè®¡ä¿¡æ¯...</p>
            </div>
        </div>

        <div class="lumi-toggle-container">
            <label for="lumi-toggle">Lumiå³æ—¶åé¦ˆ: </label>
            <label class="switch">
                <input type="checkbox" id="lumi-toggle" checked>
                <span class="slider"></span>
            </label>
        </div>

        <!-- æ·»åŠ è‡ªåŠ¨æ’­æ”¾å¼€å…³ -->
        <div class="auto-play-container" style="display: flex; align-items: center; margin-top: 10px;">
            <label for="auto-play-toggle">è‡ªåŠ¨æ’­æ”¾å‘éŸ³: </label>
            <label class="switch">
                <input type="checkbox" id="auto-play-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <!-- æ·»åŠ ç­”é¢˜å³æ—¶åé¦ˆå¼€å…³ -->
        <div class="feedback-container" style="display: flex; align-items: center; margin-top: 10px;">
            <label for="instant-feedback-toggle">ç­”é¢˜å³æ—¶åé¦ˆ: </label>
            <label class="switch">
                <input type="checkbox" id="instant-feedback-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <!-- æ·»åŠ é”™è¯æ¸…é›¶æ¨¡å¼å¼€å…³ -->
        <div class="error-clear-mode-container" style="display: flex; align-items: center; margin-top: 10px;">
            <label for="error-clear-mode-toggle">é”™è¯æ¸…é›¶æ¨¡å¼: </label>
            <label class="switch">
                <input type="checkbox" id="error-clear-mode-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <div style="display: flex; gap: 15px; margin-top: 20px; margin-bottom: 20px;">
            <button id="start-btn">å¼€å§‹æµ‹è¯•</button>
            <a href="/error-history" class="btn" style="background-color: #3498db;">æŸ¥çœ‹é”™è¯¯å†å²</a>
        </div>

        <div id="quiz-area" style="display: none;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                <h2 id="question-meaning"></h2>
                <div style="display: flex; gap: 10px;">
                    <button id="play-uk-btn" style="display: none;">è‹± ğŸ”Š</button>
                    <button id="play-us-btn" style="display: none;">ç¾ ğŸ”Š</button>
                </div>
            </div>
            <p id="question-ipa" style="font-size: 1.1em; color: #555; margin-top: 5px;"></p>
            <p id="question-meaning-en" style="font-style: italic; color: #666; margin-top: 5px;"></p>
            <p id="question-example-en" style="margin-top: 15px; font-size: 0.95em; color: #444;"></p>
            <p id="question-example-cn" style="font-size: 0.9em; color: #777;"></p>
            <p>ç¬¬ <span id="current-q-num">1</span> / <span id="total-q-num"></span> é¢˜</p>
            <div class="details-toggle">
                <button id="toggle-details-btn">æ˜¾ç¤ºæ›´å¤šè¯¦æƒ…</button>
                <div id="word-details-container" style="display: none;">
                    <p id="question-derivatives" style="margin-top: 10px; font-size: 0.9em; color: #666;"></p>
                    <p id="question-root-etymology" style="font-size: 0.9em; color: #666;"></p>
                    <p id="question-mnemonic" style="font-size: 0.9em; color: #666;"></p>
                    <p id="question-comparison" style="font-size: 0.9em; color: #666;"></p>
                    <p id="question-collocation" style="font-size: 0.9em; color: #666;"></p>
                    <p id="question-exam-sentence" style="margin-top: 10px; font-size: 0.95em; color: #444;"></p>
                    <p id="question-exam-year-source" style="font-size: 0.85em; color: #777;"></p>
                    <p id="question-exam-options" style="font-size: 0.9em; color: #444;"></p>
                    <p id="question-exam-explanation" style="font-size: 0.9em; color: #444;"></p>
                    <p id="question-tips" style="font-size: 0.9em; color: #666;"></p>
                </div>
            </div>
            <input type="text" id="answer-input" placeholder="è¾“å…¥å•è¯æ‹¼å†™...">
            <button id="next-btn" style="margin-top: 10px;">ä¸‹ä¸€é¢˜</button>
            <!-- å³ä¸‹è§’æµ®åŠ¨æŒ‰é’®åŒºåŸŸ -->
            <div id="quiz-controls" class="quiz-controls">
                <button id="back-home-btn" class="control-btn" title="è¿”å›ä¸»é¡µ">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9,22 9,12 15,12 15,22"></polyline>
                    </svg>
                </button>
                <button id="exit-quiz-btn" class="control-btn" title="é€€å‡ºæµ‹è¯•">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div id="results-area">
            <h2>æµ‹è¯•ç»“æœ</h2>
            <p>ä½ é”™äº† <strong id="error-count"></strong> ä¸ªå•è¯ã€‚</p>
            <ul id="error-list"></ul>
        </div>
    </div>
    
    <div class="lumi-reaction"></div>
    <audio id="word-audio" style="display: none;"></audio>

    <style>
        /* è¡¨å•åˆ‡æ¢åŠ¨ç”» */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }
        
        .auth-form {
            animation: fadeIn 0.4s ease forwards;
        }
        
        .auth-form.fade-out {
            animation: fadeOut 0.3s ease forwards;
        }
    </style>
    
    <script>
        // --- å…¨å±€å˜é‡ ---
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let consecutiveCorrect = 0; // è¿ç»­æ­£ç¡®çš„æ¬¡æ•°
        let lumiEnabled = true; // Lumiæ˜¾ç¤ºçŠ¶æ€
        let autoPlayEnabled = false; // è‡ªåŠ¨æ’­æ”¾çŠ¶æ€
        let instantFeedbackEnabled = false; // ç­”é¢˜å³æ—¶åé¦ˆçŠ¶æ€
        let errorClearModeEnabled = false; // é”™è¯æ¸…é›¶æ¨¡å¼çŠ¶æ€
        let currentUser = null; // å½“å‰ç™»å½•ç”¨æˆ·
        let inputEnabled = true; // è¾“å…¥æ§åˆ¶çŠ¶æ€
        const lumiImages = {
            'welcome': '/assets/img/Lumi/Lumi_ReadingontheLaptop_SmilingattheScreen.png',
            'thinking': '/assets/img/Lumi/Lumi_HoldingWordCard.png',
            'correct': '/assets/img/Lumi/Lumi_Triumph.png',
            'wrong': '/assets/img/Lumi/Lumi_Crying.png',
            'celebration': '/assets/img/Lumi/Lumi_Yeah.png'
        };
        
        // é”™è¯æ¸…é›¶æ¨¡å¼ç›¸å…³å˜é‡
        let errorClearModeData = {
            isActive: false,
            currentRound: 1,
            originalQuestions: [],
            currentQuestions: [],
            incorrectWords: [],
            roundResults: []
        };
        
        // --- DOM å…ƒç´ ç¼“å­˜ ---
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const loginUsername = document.getElementById('login-username');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const loginBtn = document.getElementById('login-btn');
        const registerUsername = document.getElementById('register-username');
        const registerPassword = document.getElementById('register-password');
        const registerConfirmPassword = document.getElementById('register-confirm-password');
        const registerError = document.getElementById('register-error');
        const registerBtn = document.getElementById('register-btn');
        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');
        const userInfoEl = document.getElementById('user-info');
        const logoutBtn = document.getElementById('logout-btn');
        
        const startBtn = document.getElementById('start-btn');
        const quizArea = document.getElementById('quiz-area');
        const resultsArea = document.getElementById('results-area');
        const questionMeaningEl = document.getElementById('question-meaning');
        const questionIpaEl = document.getElementById('question-ipa');
        const questionMeaningEnEl = document.getElementById('question-meaning-en');
        const questionExampleEnEl = document.getElementById('question-example-en');
        const questionExampleCnEl = document.getElementById('question-example-cn');
        const currentQNumEl = document.getElementById('current-q-num');
        const totalQNumEl = document.getElementById('total-q-num');
        const answerInput = document.getElementById('answer-input');
        const nextBtn = document.getElementById('next-btn');
        const audioEl = document.getElementById('word-audio');
        const ukBtn = document.getElementById('play-uk-btn');
        const usBtn = document.getElementById('play-us-btn');

        const toggleDetailsBtn = document.getElementById('toggle-details-btn');
        const wordDetailsContainer = document.getElementById('word-details-container');

        const questionDerivativesEl = document.getElementById('question-derivatives');
        const questionRootEtymologyEl = document.getElementById('question-root-etymology');
        const questionMnemonicEl = document.getElementById('question-mnemonic');
        const questionComparisonEl = document.getElementById('question-comparison');
        const questionCollocationEl = document.getElementById('question-collocation');
        const questionExamSentenceEl = document.getElementById('question-exam-sentence');
        const questionExamYearSourceEl = document.getElementById('question-exam-year-source');
        const questionExamOptionsEl = document.getElementById('question-exam-options');
        const questionExamExplanationEl = document.getElementById('question-exam-explanation');
        const questionTipsEl = document.getElementById('question-tips');
        const lumiImg = document.querySelector('.lumi-reaction');
        const lumiToggle = document.getElementById('lumi-toggle');
        const autoPlayToggle = document.getElementById('auto-play-toggle');
        const instantFeedbackToggle = document.getElementById('instant-feedback-toggle');
        const errorClearModeToggle = document.getElementById('error-clear-mode-toggle');

        // --- åŠŸèƒ½å‡½æ•° ---
        
        // æ ¼å¼åŒ–è¯æ€§å’Œæ„æ€çš„å‡½æ•°
        function formatPOSAndMeaning(pos, meaning) {
            if (!pos || !meaning) {
                return { extractedPos: pos || '', formattedMeaning: meaning || '' };
            }
            
            // æå–è¯æ€§ä¿¡æ¯
            const posMatch = pos.match(/^([^ï¼Œã€‚ï¼›]*?)(?=[ï¼Œã€‚ï¼›]|$)/);
            const extractedPos = posMatch ? posMatch[1].trim() : pos;
            
            // æ ¼å¼åŒ–æ„æ€ï¼Œå°†è¯æ€§ä¿¡æ¯ç”¨æ–œä½“æ˜¾ç¤º
            let formattedMeaning = meaning;
            if (extractedPos && extractedPos !== pos) {
                // å¦‚æœæå–çš„è¯æ€§ä¸åŸå§‹è¯æ€§ä¸åŒï¼Œè¯´æ˜æœ‰å¤šä¸ªè¯æ€§
                const posParts = pos.split(/[ï¼Œã€‚ï¼›]/);
                formattedMeaning = posParts.map((part, index) => {
                    if (index === 0) {
                        return `<em style="color: #007bff; font-weight: bold;">${part.trim()}</em>`;
                    } else {
                        return part.trim();
                    }
                }).join('ï¼›');
            } else {
                // å•ä¸ªè¯æ€§
                formattedMeaning = `<em style="color: #007bff; font-weight: bold;">${extractedPos}</em> ${meaning}`;
            }
            
            return { extractedPos, formattedMeaning };
        }
        
        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            // ä»sessionStorageè·å–ç”¨æˆ·ä¿¡æ¯
            const userJson = sessionStorage.getItem('currentUser');
            if (userJson) {
                try {
                    currentUser = JSON.parse(userJson);
                    showAppInterface();
                } catch (e) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
                    showAuthInterface();
                }
            } else {
                showAuthInterface();
            }
        }
        
        // æ˜¾ç¤ºè®¤è¯ç•Œé¢
        function showAuthInterface() {
            authContainer.style.display = 'block';
            appContainer.style.display = 'none';
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
        }
        
        // æ˜¾ç¤ºåº”ç”¨ç•Œé¢
        function showAppInterface() {
            authContainer.style.display = 'none';
            appContainer.style.display = 'block';
            if (currentUser) {
                // æ¸…ç©ºç”¨æˆ·ä¿¡æ¯å…ƒç´ 
                userInfoEl.innerHTML = '';
                
                // åˆ›å»ºæ¬¢è¿æ–‡æœ¬
                const welcomeText = document.createElement('span');
                welcomeText.textContent = `æ¬¢è¿, ${currentUser.username} (${currentUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'å­¦ç”Ÿ'})`;
                userInfoEl.appendChild(welcomeText);
                
                // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ·»åŠ ä»ªè¡¨ç›˜é“¾æ¥
                if (currentUser.role === 'admin') {
                    const dashboardLink = document.createElement('a');
                    dashboardLink.href = '/admin';
                    dashboardLink.className = 'admin-dashboard-link';
                    dashboardLink.innerHTML = '<i class="fas fa-chart-line"></i> ç®¡ç†ä»ªè¡¨ç›˜';
                    dashboardLink.style.marginLeft = '15px';
                    dashboardLink.style.color = '#8e44ad';
                    dashboardLink.style.textDecoration = 'none';
                    dashboardLink.style.fontWeight = 'bold';
                    userInfoEl.appendChild(dashboardLink);
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¸Šæ¬¡çš„æµ‹è¯•è¿›åº¦
            checkLastQuizProgress();
            
            // ç¡®ä¿ Lumi å¼€å…³çŠ¶æ€æ­£ç¡®
            lumiEnabled = lumiToggle.checked;
            if (!lumiEnabled) {
                lumiImg.classList.remove('active');
            } else {
                updateLumiReaction('welcome');
            }
        }

        // æ£€æŸ¥ä¸Šæ¬¡æµ‹è¯•è¿›åº¦çš„å‡½æ•°
        function checkLastQuizProgress() {
            const savedProgress = localStorage.getItem('quizProgress');
            if (savedProgress) {
                try {
                    const progress = JSON.parse(savedProgress);
                    const timeDiff = new Date() - new Date(progress.timestamp);
                    const hoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                    
                    // å¦‚æœè¿›åº¦æ˜¯24å°æ—¶å†…çš„ï¼Œæ˜¾ç¤ºæç¤º
                    if (hoursDiff < 24) {
                        const progressMsg = document.createElement('div');
                        progressMsg.style.cssText = `
                            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
                            border: 1px solid #ffc107;
                            border-radius: 8px;
                            padding: 15px;
                            margin: 15px 0;
                            color: #856404;
                            font-size: 0.95em;
                        `;
                        progressMsg.innerHTML = `
                            <strong>ğŸ“š ä¸Šæ¬¡æµ‹è¯•è¿›åº¦æé†’</strong><br>
                            ä½ åœ¨ ${hoursDiff} å°æ—¶å‰å®Œæˆäº† ${progress.progress_percentage}% çš„æµ‹è¯•<br>
                            (${progress.answered_questions}/${progress.total_questions} é¢˜ï¼Œæ­£ç¡® ${progress.correct_answers} é¢˜)<br>
                            <button onclick="clearProgress()" style="margin-top: 8px; padding: 5px 10px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">æ¸…é™¤æé†’</button>
                        `;
                        
                        // æ’å…¥åˆ°å¼€å§‹æŒ‰é’®ä¹‹å‰
                        const startBtn = document.getElementById('start-btn');
                        startBtn.parentNode.insertBefore(progressMsg, startBtn);
                    }
                } catch (error) {
                    console.error('è§£æä¿å­˜çš„è¿›åº¦æ—¶å‡ºé”™:', error);
                    localStorage.removeItem('quizProgress');
                }
            }
        }

        // æ¸…é™¤è¿›åº¦æé†’çš„å‡½æ•°
        function clearProgress() {
            localStorage.removeItem('quizProgress');
            location.reload();
        }
        
        // å¤„ç†ç™»å½•
        async function handleLogin() {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();
            
            if (!username || !password) {
                loginError.textContent = 'ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º';
                loginError.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // ç™»å½•æˆåŠŸ
                    currentUser = data.user;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showAppInterface();
                    loginUsername.value = '';
                    loginPassword.value = '';
                    loginError.style.display = 'none';
                } else {
                    // ç™»å½•å¤±è´¥
                    loginError.textContent = data.error || 'ç™»å½•å¤±è´¥';
                    loginError.style.display = 'block';
                }
            } catch (error) {
                console.error('ç™»å½•è¯·æ±‚å‡ºé”™:', error);
                loginError.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
                loginError.style.display = 'block';
            }
        }
        
        // å¤„ç†æ³¨å†Œ
        async function handleRegister() {
            const username = registerUsername.value.trim();
            const password = registerPassword.value.trim();
            const confirmPassword = registerConfirmPassword.value.trim();
            
            if (!username || !password || !confirmPassword) {
                registerError.textContent = 'æ‰€æœ‰å­—æ®µéƒ½å¿…é¡»å¡«å†™';
                registerError.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                registerError.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´';
                registerError.style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    // æ³¨å†ŒæˆåŠŸï¼Œåˆ‡æ¢åˆ°ç™»å½•è¡¨å•
                    registerUsername.value = '';
                    registerPassword.value = '';
                    registerConfirmPassword.value = '';
                    registerError.style.display = 'none';
                    loginUsername.value = username; // è‡ªåŠ¨å¡«å……ç”¨æˆ·å
                    
                    // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                    registerForm.classList.add('fade-out');
                    
                    // ç­‰å¾…åŠ¨ç”»å®Œæˆååˆ‡æ¢è¡¨å•
                    setTimeout(function() {
                        registerForm.style.display = 'none';
                        registerForm.classList.remove('fade-out');
                        
                        // æ˜¾ç¤ºç™»å½•è¡¨å•å¹¶æ·»åŠ æ·¡å…¥åŠ¨ç”»
                        loginForm.style.display = 'block';
                        
                        // ä½¿ç”¨æ›´ç°ä»£çš„é€šçŸ¥è€Œä¸æ˜¯ alert
                        const notification = document.createElement('div');
                        notification.className = 'auth-notification';
                        notification.textContent = 'æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•';
                        loginForm.prepend(notification);
                        
                        // 3ç§’åè‡ªåŠ¨ç§»é™¤é€šçŸ¥
                        setTimeout(() => {
                            notification.style.opacity = '0';
                            setTimeout(() => notification.remove(), 500);
                        }, 3000);
                    }, 300);
                } else {
                    // æ³¨å†Œå¤±è´¥
                    registerError.textContent = data.error || 'æ³¨å†Œå¤±è´¥';
                    registerError.style.display = 'block';
                }
            } catch (error) {
                console.error('æ³¨å†Œè¯·æ±‚å‡ºé”™:', error);
                registerError.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•';
                registerError.style.display = 'block';
            }
        }
        
        // å¤„ç†é€€å‡ºç™»å½•
        function handleLogout() {
            // æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            
            // é‡ç½®æµ‹è¯•çŠ¶æ€
            questions = [];
            currentQuestionIndex = 0;
            userAnswers = [];
            consecutiveCorrect = 0;
            
            // æ¸…é™¤ç•Œé¢çŠ¶æ€
            quizArea.style.display = 'none';
            resultsArea.style.display = 'none';
            answerInput.value = '';
            questionMeaningEl.textContent = '';
            questionIpaEl.textContent = '';
            questionMeaningEnEl.textContent = '';
            
            // é‡ç½®è¯¦æƒ…åŒºåŸŸ
            wordDetailsContainer.style.display = 'none';
            toggleDetailsBtn.textContent = 'æ˜¾ç¤ºæ›´å¤šè¯¦æƒ…';
            
            // æ˜¾ç¤ºç™»å½•ç•Œé¢
            showAuthInterface();
        }
        
        // åŠ¨æ€åŠ è½½è¯ä¹¦åˆ—è¡¨
        async function loadBookLists() {
            try {
                const bookSelect = document.getElementById('book-select');
                const response = await fetch('/api/books');
                if (!response.ok) throw new Error('è·å–è¯ä¹¦åˆ—è¡¨å¤±è´¥');
                const books = await response.json();
                
                bookSelect.innerHTML = ''; // æ¸…ç©ºåŠ è½½ä¸­é€‰é¡¹
                
                if (books && books.length > 0) {
                    books.forEach(book => {
                        const option = document.createElement('option');
                        option.value = book.id;
                        option.textContent = book.name;
                        bookSelect.appendChild(option);
                    });
                    // åŠ è½½ç¬¬ä¸€æœ¬ä¹¦çš„å•å…ƒåˆ—è¡¨
                    loadWordLists(books[0].id);
                } else {
                    bookSelect.innerHTML = '<option value="">æ— å¯ç”¨è¯ä¹¦</option>';
                    document.getElementById('list-select').innerHTML = '<option value="">æ— å¯ç”¨å•å…ƒ</option>';
                }
            } catch (error) {
                console.error('åŠ è½½è¯ä¹¦åˆ—è¡¨æ—¶å‡ºé”™:', error);
                document.getElementById('book-select').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                document.getElementById('list-select').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }
        
        // åŠ¨æ€åŠ è½½å•è¯åˆ—è¡¨ï¼ˆæ ¹æ®é€‰å®šçš„è¯ä¹¦ï¼‰
        async function loadWordLists(bookId) {
            try {
                const listSelect = document.getElementById('list-select');
                listSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
                
                const url = bookId ? `/api/lists?book_id=${bookId}` : '/api/lists';
                const response = await fetch(url);
                if (!response.ok) throw new Error('è·å–å•å…ƒåˆ—è¡¨å¤±è´¥');
                const lists = await response.json();
                
                listSelect.innerHTML = ''; // æ¸…ç©ºåŠ è½½ä¸­é€‰é¡¹
                
                if (lists && lists.length > 0) {
                    lists.forEach(list => {
                        const option = document.createElement('option');
                        option.value = list.id;
                        option.textContent = list.name;
                        listSelect.appendChild(option);
                    });
                } else {
                    listSelect.innerHTML = '<option value="">æ— å¯ç”¨å•å…ƒ</option>';
                }
            } catch (error) {
                console.error('åŠ è½½å•å…ƒåˆ—è¡¨æ—¶å‡ºé”™:', error);
                document.getElementById('list-select').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
            }
        }

        // é¢„å¤„ç†æ–‡æœ¬ä»¥æ”¹è¿›TTSå‘éŸ³
        function preprocessTextForTTS(text) {
            if (!text) return text;
            
            // æ›¿æ¢ "a/an" ä¸º "a or an"
            text = text.replace(/\ba\/an\b/gi, "a or an");
            
            // æ›¿æ¢å…¶ä»–å¯èƒ½å¯¼è‡´TTSå‘éŸ³é—®é¢˜çš„æ¨¡å¼
            text = text.replace(/\b(\w+)\/(\w+)\b/gi, "$1 or $2"); // å°† "word1/word2" æ›¿æ¢ä¸º "word1 or word2"
            
            // ä¸å¯¹å•è¯è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œè®©æ¯ä¸ªå•è¯ä½¿ç”¨è‡ªå·±çš„æ­£ç¡®å‘éŸ³
            // é¿å…åƒ"dare"ç­‰å•è¯è¢«é”™è¯¯åœ°å‘éŸ³ä¸º"horoscope"çš„é—®é¢˜
            
            return text;
        }
        
        // TTS æœ—è¯»å‡½æ•°
        function playTTS(text) {
            if ('speechSynthesis' in window) {
                // é¢„å¤„ç†æ–‡æœ¬ä»¥æ”¹è¿›å‘éŸ³
                const processedText = preprocessTextForTTS(text);
                
                const utterance = new SpeechSynthesisUtterance(processedText);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            } else {
                console.error('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
            }
        }

        // éŸ³é¢‘æ’­æ”¾å‡½æ•°ï¼ˆå¸¦TTSåå¤‡ï¼‰
        function playAudio(audioPath, fallbackText) {
            // æ£€æŸ¥å½“å‰å­¦ä¹ æ¨¡å¼ï¼Œå¦‚æœæ˜¯é»˜å†™æ¨¡å¼åˆ™ä¸æ’­æ”¾
            const studyMode = document.getElementById('study-mode').value;
            if (studyMode === 'dictation') return;
            
            if (audioPath && audioPath.trim() !== "") {
                // å°è¯•ä½¿ç”¨æœ¬åœ°éŸ³é¢‘æ–‡ä»¶
                audioEl.src = audioPath;
                const playPromise = audioEl.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.error(`æœ¬åœ°éŸ³é¢‘æ’­æ”¾å¤±è´¥: ${audioPath}`, error);
                        // æœ¬åœ°éŸ³é¢‘å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨TTS API
                        if (fallbackText) {
                            // é¦–å…ˆå°è¯•ä½¿ç”¨åç«¯TTS API
                            fetch(`/api/tts/${encodeURIComponent(fallbackText)}`)
                                .then(response => {
                                    if (response.ok) {
                                        // ä½¿ç”¨åç«¯ç”Ÿæˆçš„TTSéŸ³é¢‘
                                        return response.blob();
                                    } else {
                                        // åç«¯TTSå¤±è´¥ï¼Œä½¿ç”¨æµè§ˆå™¨TTS
                                        throw new Error('åç«¯TTS APIå¤±è´¥');
                                    }
                                })
                                .then(blob => {
                                    const audioUrl = URL.createObjectURL(blob);
                                    audioEl.src = audioUrl;
                                    return audioEl.play();
                                })
                                .catch(err => {
                                    console.error('åç«¯TTSå¤±è´¥ï¼Œä½¿ç”¨æµè§ˆå™¨TTS:', err);
                                    // æœ€åä½¿ç”¨æµè§ˆå™¨TTSä½œä¸ºå¤‡é€‰
                                    playTTS(fallbackText);
                                });
                        } else {
                            console.error('æ²¡æœ‰å¯ç”¨çš„å¤‡é€‰æ–‡æœ¬è¿›è¡ŒTTS');
                        }
                    });
                }
            } else if (fallbackText) {
                // æ²¡æœ‰æœ¬åœ°éŸ³é¢‘ï¼Œå°è¯•ä½¿ç”¨åç«¯TTS API
                fetch(`/api/tts/${encodeURIComponent(fallbackText)}`)
                    .then(response => {
                        if (response.ok) {
                            // ä½¿ç”¨åç«¯ç”Ÿæˆçš„TTSéŸ³é¢‘
                            return response.blob();
                        } else {
                            // åç«¯TTSå¤±è´¥ï¼Œä½¿ç”¨æµè§ˆå™¨TTS
                            throw new Error('åç«¯TTS APIå¤±è´¥');
                        }
                    })
                    .then(blob => {
                        const audioUrl = URL.createObjectURL(blob);
                        audioEl.src = audioUrl;
                        return audioEl.play();
                    })
                    .catch(err => {
                        console.error('åç«¯TTSå¤±è´¥ï¼Œä½¿ç”¨æµè§ˆå™¨TTS:', err);
                        // æœ€åä½¿ç”¨æµè§ˆå™¨TTSä½œä¸ºå¤‡é€‰
                        playTTS(fallbackText);
                    });
            } else {
                console.error('æ²¡æœ‰å¯ç”¨çš„éŸ³é¢‘è·¯å¾„æˆ–å¤‡é€‰æ–‡æœ¬');
            }
        }

        // è‡ªåŠ¨æ’­æ”¾éŸ³é¢‘åºåˆ—ï¼ˆè‹±éŸ³ç„¶åç¾éŸ³ï¼‰
        function autoPlayAudios() {
            if (!autoPlayEnabled) return;
            
            // æ£€æŸ¥å½“å‰å­¦ä¹ æ¨¡å¼ï¼Œå¦‚æœæ˜¯é»˜å†™æ¨¡å¼åˆ™ä¸æ’­æ”¾
            const studyMode = document.getElementById('study-mode').value;
            if (studyMode === 'dictation') return;
            
            const q = questions[currentQuestionIndex];
            
            // å…ˆæ’­æ”¾è‹±éŸ³
            if (q.audio_path_uk) {
                playAudio(q.audio_path_uk, q.spelling);
                
                // ç­‰å¾…è‹±éŸ³æ’­æ”¾å®Œæ¯•åæ’­æ”¾ç¾éŸ³
                setTimeout(() => {
                    if (q.audio_path_us) {
                        playAudio(q.audio_path_us, q.spelling);
                    }
                }, 1500); // å‡è®¾æ¯ä¸ªéŸ³é¢‘å¤§çº¦éœ€è¦1.5ç§’
            } else if (q.audio_path_us) {
                // å¦‚æœæ²¡æœ‰è‹±éŸ³ä½†æœ‰ç¾éŸ³ï¼Œç›´æ¥æ’­æ”¾ç¾éŸ³
                playAudio(q.audio_path_us, q.spelling);
            } else {
                // å¦‚æœéƒ½æ²¡æœ‰ï¼Œä½¿ç”¨TTS
                playTTS(q.spelling);
            }
        }

        // æ›´æ–°LumiçŠ¶æ€
        function updateLumiReaction(state) {
            if (!lumiImg || !lumiImages[state] || !lumiEnabled) return;
            lumiImg.classList.remove('bounce');
            lumiImg.style.backgroundImage = `url(${lumiImages[state]})`;
            if (!lumiImg.classList.contains('active')) {
                lumiImg.classList.add('active');
            }
            if (state === 'correct' || state === 'celebration') {
                void lumiImg.offsetWidth; // è§¦å‘é‡æ’ä»¥é‡ç½®åŠ¨ç”»
                lumiImg.classList.add('bounce');
            }
            
            // æ¯æ¬¡æ›´æ–° Lumi çŠ¶æ€æ—¶æ£€æŸ¥ä½ç½®
            checkLumiPosition();
        }
        
        // æ£€æŸ¥å¹¶è°ƒæ•´ Lumi çš„ä½ç½®
        function checkLumiPosition() {
            if (!lumiImg || !lumiEnabled) return;
            
            const quizAreaRect = quizArea.getBoundingClientRect();
            const windowHeight = window.innerHeight;
            const lumiHeight = lumiImg.offsetHeight;
            
            // ä¿å­˜å½“å‰çš„åŠ¨ç”»çŠ¶æ€
            const wasActive = lumiImg.classList.contains('active');
            const wasBounce = lumiImg.classList.contains('bounce');
            
            // æ¸…é™¤ä¹‹å‰çš„ä½ç½®ç±»å’ŒåŠ¨ç”»ç±»
            lumiImg.classList.remove('corner', 'hidden', 'active', 'bounce');
            
            // å¦‚æœçª—å£é«˜åº¦å°äº 700pxï¼Œå®Œå…¨éšè— Lumi
            if (windowHeight < 700) {
                lumiImg.classList.add('hidden');
                return;
            }
            
            // å¦‚æœ quiz-area åœ¨è§†å£ä¸­ä¸”ä¸ Lumi æœ‰é‡å ï¼Œå°† Lumi ç§»åˆ°è§’è½
            let shouldBeInCorner = false;
            if (quizArea.style.display !== 'none') {
                const lumiBottom = windowHeight - 3 * windowHeight / 100; // 3vh è½¬æ¢ä¸ºåƒç´ 
                const lumiTop = lumiBottom - lumiHeight;
                
                // æ£€æŸ¥ Lumi æ˜¯å¦ä¸ quiz-area é‡å 
                if (lumiTop < quizAreaRect.bottom && quizAreaRect.top < lumiBottom) {
                    shouldBeInCorner = true;
                }
            }
            
            // åº”ç”¨ä½ç½®ç±»
            if (shouldBeInCorner) {
                lumiImg.classList.add('corner');
            }
            
            // æ¢å¤åŠ¨ç”»çŠ¶æ€
            if (wasActive) {
                lumiImg.classList.add('active');
            }
            if (wasBounce) {
                // é‡æ–°è§¦å‘å¼¹è·³åŠ¨ç”»
                void lumiImg.offsetWidth; // è§¦å‘é‡æ’ä»¥é‡ç½®åŠ¨ç”»
                lumiImg.classList.add('bounce');
            }
        }

        // æ˜¾ç¤ºé—®é¢˜
        function displayQuestion() {
            const q = questions[currentQuestionIndex];
            const studyMode = document.getElementById('study-mode').value;
            
            // ä½¿ç”¨ formatPOSAndMeaning å‡½æ•°å¤„ç†è¯æ€§å’Œæ„æ€
            const { extractedPos, formattedMeaning } = formatPOSAndMeaning(q.pos, q.meaning_cn);
            
            // æ˜¾ç¤ºæ ¼å¼åŒ–åçš„ä¸­æ–‡é‡Šä¹‰ï¼ŒåŒ…å«è¯æ€§ä¿¡æ¯
            questionMeaningEl.innerHTML = formattedMeaning || ''; // ä½¿ç”¨ innerHTML ä»¥æ”¯æŒ <br> æ ‡ç­¾
            questionIpaEl.textContent = q.ipa ? `/${q.ipa}/` : ''; // éŸ³æ ‡
            questionMeaningEnEl.textContent = q.meaning_en || ''; // è‹±æ–‡é‡Šä¹‰
            questionExampleEnEl.textContent = q.example_en || ''; // ä¾‹å¥è‹±æ–‡
            questionExampleCnEl.textContent = q.example_cn || ''; // ä¾‹å¥ä¸­æ–‡

            // é”™è¯å¤ä¹ æ¨¡å¼ï¼šå‡†å¤‡é”™è¯¯ç»Ÿè®¡ä¿¡æ¯ï¼ˆä½†ä¸ç«‹å³æ˜¾ç¤ºï¼‰
            let errorInfo = null;
            if (studyMode === 'error_review' && q.error_count) {
                errorInfo = document.createElement('div');
                errorInfo.className = 'error-info';
                errorInfo.style.cssText = `
                    background: #fffbe6;
                    border-left: 3px solid #ffeaa7;
                    border-radius: 0 6px 6px 0;
                    padding: 6px 12px;
                    margin: 8px 0 0 0;
                    color: #856404;
                    font-size: 0.85em;
                    line-height: 1.5;
                    font-weight: normal;
                    box-shadow: none;
                `;
                errorInfo.innerHTML = `
                    <span style="font-size:0.95em;">ğŸ“Š é”™è¯ç»Ÿè®¡ï¼š</span>
                    å·²é”™è¯¯ <strong>${q.error_count}</strong> æ¬¡
                    ${q.last_error_date ? `ï¼Œæœ€è¿‘é”™è¯¯ï¼š${q.last_error_date}` : ''}
                    ${q.book_name && q.list_name ? `ï¼Œæ¥è‡ªï¼š${q.book_name} - ${q.list_name}` : q.list_name ? `ï¼Œæ¥è‡ªï¼š${q.list_name}` : ''}
                `;
            }
            
            // ç§»é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            const existingErrorInfo = document.querySelector('.error-info');
            if (existingErrorInfo) existingErrorInfo.remove();

            // å¡«å……æ›´å¤šè¯¦ç»†ä¿¡æ¯
            questionDerivativesEl.textContent = q.derivatives ? `æ´¾ç”Ÿè¯: ${q.derivatives}` : '';
            questionRootEtymologyEl.textContent = q.root_etymology ? `è¯æ ¹è¯æº: ${q.root_etymology}` : '';
            questionMnemonicEl.textContent = q.mnemonic ? `è”æƒ³è®°å¿†: ${q.mnemonic}` : '';
            questionComparisonEl.textContent = q.comparison ? `è¯ä¹‰è¾¨æ: ${q.comparison}` : '';
            questionCollocationEl.textContent = q.collocation ? `æ­é…ç”¨æ³•: ${q.collocation}` : '';
            questionExamSentenceEl.textContent = q.exam_sentence ? `çœŸé¢˜ä¾‹å¥: ${q.exam_sentence}` : '';
            questionExamYearSourceEl.textContent = q.exam_year_source ? `çœŸé¢˜å‡ºå¤„: ${q.exam_year_source}` : '';
            questionExamOptionsEl.textContent = q.exam_options ? `é€‰é¡¹: ${q.exam_options}` : '';
            questionExamExplanationEl.textContent = q.exam_explanation ? `è§£æ: ${q.exam_explanation}` : '';
            questionTipsEl.textContent = q.tips ? `æç¤º: ${q.tips}` : '';
            
            // å¦‚æœæœ‰é”™è¯ç»Ÿè®¡ä¿¡æ¯ï¼Œæ·»åŠ åˆ°è¯¦æƒ…å®¹å™¨çš„æœ€å‰é¢
            if (errorInfo) {
                wordDetailsContainer.insertBefore(errorInfo, wordDetailsContainer.firstChild);
            }

            // æ ¹æ®å­¦ä¹ æ¨¡å¼å†³å®šæ˜¯å¦é»˜è®¤å±•å¼€è¯¦æƒ…
            if (studyMode === 'learning' || studyMode === 'error_review') {
                // å­¦ä¹ æ¨¡å¼å’Œé”™è¯å¤ä¹ æ¨¡å¼ä¸‹é»˜è®¤å±•å¼€è¯¦æƒ…
                wordDetailsContainer.style.display = 'block';
                toggleDetailsBtn.textContent = 'éšè—æ›´å¤šè¯¦æƒ…';
            } else {
                // å…¶ä»–æ¨¡å¼ä¸‹é»˜è®¤éšè—è¯¦æƒ…
                wordDetailsContainer.style.display = 'none';
                toggleDetailsBtn.textContent = 'æ˜¾ç¤ºæ›´å¤šè¯¦æƒ…';
            }
            
            currentQNumEl.textContent = currentQuestionIndex + 1;

            // æ ¹æ®å­¦ä¹ æ¨¡å¼å’ŒéŸ³é¢‘è·¯å¾„å†³å®šæ˜¯å¦æ˜¾ç¤ºéŸ³é¢‘æŒ‰é’®
            const showAudio = studyMode === 'standard' || studyMode === 'error_review';
            
            // æ˜¾ç¤ºTTSæŒ‰é’®ï¼Œæ— è®ºæ˜¯å¦æœ‰æœ¬åœ°éŸ³é¢‘
            const ttsBtn = document.createElement('button');
            ttsBtn.className = 'audio-btn';
            ttsBtn.innerHTML = '<i class="fas fa-volume-up"></i> TTS';
            ttsBtn.onclick = () => playTTS(q.spelling);
            
            // æ¸…é™¤ä¹‹å‰çš„TTSæŒ‰é’®
            const oldTtsBtn = document.querySelector('.audio-btn.tts-btn');
            if (oldTtsBtn) oldTtsBtn.remove();
            
            // æ·»åŠ TTSæŒ‰é’®æ ·å¼
            ttsBtn.classList.add('tts-btn');
            ttsBtn.style.backgroundColor = '#9b59b6';
            ttsBtn.style.marginLeft = '5px';
            
            // æ˜¾ç¤ºéŸ³é¢‘æŒ‰é’®
            ukBtn.style.display = showAudio && q.audio_path_uk ? 'inline-block' : 'none';
            usBtn.style.display = showAudio && q.audio_path_us ? 'inline-block' : 'none';
            
            if (showAudio) {
                if (q.audio_path_uk) ukBtn.onclick = () => playAudio(q.audio_path_uk, q.spelling);
                if (q.audio_path_us) usBtn.onclick = () => playAudio(q.audio_path_us, q.spelling);
                
                // æ·»åŠ TTSæŒ‰é’®åˆ°éŸ³é¢‘æŒ‰é’®åŒºåŸŸ
                const audioButtonsContainer = ukBtn.parentElement;
                audioButtonsContainer.appendChild(ttsBtn);
            }

            nextBtn.textContent = (currentQuestionIndex === questions.length - 1) ? 'å®Œæˆå¹¶æäº¤' : 'ä¸‹ä¸€é¢˜';
            
            // æ–°é¢˜æ˜¾ç¤ºåï¼Œæ·»åŠ å»¶æ—¶æ§åˆ¶
            inputEnabled = false; // ç¦ç”¨"ä¸‹ä¸€ä¸ª"æ“ä½œ
            nextBtn.disabled = true;
            
            // 0.6ç§’åå¯ç”¨"ä¸‹ä¸€ä¸ª"æ“ä½œ
            setTimeout(() => {
                inputEnabled = true;
                nextBtn.disabled = false;
                answerInput.focus();
            }, 600);
            
            // å¦‚æœå¯ç”¨äº†è‡ªåŠ¨æ’­æ”¾ä¸”æ”¯æŒéŸ³é¢‘ï¼Œè‡ªåŠ¨æ’­æ”¾éŸ³é¢‘
            if (autoPlayEnabled && showAudio) {
                setTimeout(() => autoPlayAudios(), 500); // å»¶è¿Ÿ500msåæ’­æ”¾ï¼Œç»™é¡µé¢æ¸²æŸ“ä¸€äº›æ—¶é—´
            }
        }

        // å¤„ç†"ä¸‹ä¸€æ­¥"é€»è¾‘
        function handleNextQuestion() {
            const currentAnswer = answerInput.value.trim().toLowerCase();
            const correctSpelling = questions[currentQuestionIndex].spelling.trim().toLowerCase();
            
            // å¤„ç†æ–œæ åˆ†éš”çš„æ‹¼å†™å˜ä½“
            const slashSpellings = correctSpelling.split('/');
            
            // å¤„ç†é€—å·åˆ†éš”çš„æ‹¼å†™å˜ä½“
            let validSpellings = [];
            slashSpellings.forEach(spelling => {
                if (spelling.includes(',')) {
                    // å¯¹äºé€—å·åˆ†éš”çš„å˜ä½“ï¼Œå°†å®ƒä»¬åˆ†å¼€å¹¶æ·»åŠ åˆ°æœ‰æ•ˆæ‹¼å†™åˆ—è¡¨ä¸­
                    const commaVariants = spelling.split(',').map(v => v.trim().toLowerCase());
                    validSpellings = validSpellings.concat(commaVariants);
                } else {
                    validSpellings.push(spelling);
                }
            });
            
            // ç§»é™¤ä¹‹å‰çš„æ–‡å­—åé¦ˆæç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
            const existingFeedback = document.querySelector('.text-feedback');
            if (existingFeedback) {
                existingFeedback.parentNode.removeChild(existingFeedback);
            }
            
            if (validSpellings.includes(currentAnswer)) {
                // ç­”æ¡ˆæ­£ç¡®
                consecutiveCorrect++; // è¿ç»­æ­£ç¡®æ¬¡æ•°+1
                
                // æ ¹æ®è¿ç»­æ­£ç¡®çš„æ¬¡æ•°ï¼Œå†³å®šLumiçš„è¡¨æƒ…
                if (consecutiveCorrect >= 3) {
                    updateLumiReaction('celebration'); // è¿ç»­3æ¬¡ä»¥ä¸Šæ­£ç¡®ï¼Œä½¿ç”¨åº†ç¥è¡¨æƒ…
                } else {
                    updateLumiReaction('correct'); // æ™®é€šçš„æ­£ç¡®åé¦ˆ
                }
                
                // å¦‚æœå¯ç”¨äº†å³æ—¶åé¦ˆï¼Œæ˜¾ç¤ºæ­£ç¡®åé¦ˆ
                if (instantFeedbackEnabled) {
                    const feedbackEl = document.createElement('div');
                    feedbackEl.className = 'text-feedback';
                    feedbackEl.innerHTML = `<span style="color: #27ae60">âœ“ æ­£ç¡®!</span>`;
                    feedbackEl.style.marginTop = '10px';
                    feedbackEl.style.padding = '8px';
                    feedbackEl.style.backgroundColor = '#f0fff4';
                    feedbackEl.style.borderLeft = '4px solid #27ae60';
                    feedbackEl.style.borderRadius = '4px';
                    answerInput.parentNode.appendChild(feedbackEl);
                }
                
                // å¦‚æœæœ‰å¤šç§æ‹¼å†™æ–¹å¼ï¼Œä¸”ç”¨æˆ·ä½¿ç”¨äº†å…¶ä¸­ä¸€ç§ï¼Œæç¤ºå…¶ä»–å¯èƒ½çš„å†™æ³•
                if (validSpellings.length > 1 && currentAnswer !== correctSpelling) {
                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶æç¤ºå…ƒç´ 
                    const spellingTip = document.createElement('div');
                    spellingTip.className = 'spelling-tip';
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤ºæ‰€æœ‰å¯èƒ½çš„æ‹¼å†™å½¢å¼
                    let formattedSpellings;
                    if (correctSpelling.includes('/') || correctSpelling.includes(',')) {
                        // å¦‚æœåŸå§‹æ‹¼å†™åŒ…å«åˆ†éš”ç¬¦ï¼Œåˆ™æ˜¾ç¤ºæ‰€æœ‰æœ‰æ•ˆæ‹¼å†™
                        formattedSpellings = validSpellings
                            .filter(s => s !== currentAnswer) // æ’é™¤ç”¨æˆ·å½“å‰è¾“å…¥çš„æ‹¼å†™
                            .map(s => `<span class="spelling-variant">${s}</span>`)
                            .join(' æˆ– ');
                    } else {
                        // å¦åˆ™ç›´æ¥æ˜¾ç¤ºåŸå§‹æ‹¼å†™
                        formattedSpellings = `<strong>${correctSpelling}</strong>`;
                    }
                    
                    spellingTip.innerHTML = `<span style="color: #27ae60">âœ“ æ­£ç¡®!</span> è¯¥å•è¯è¿˜æœ‰å…¶ä»–æ‹¼å†™å½¢å¼: ${formattedSpellings}`;
                    spellingTip.style.marginTop = '10px';
                    spellingTip.style.padding = '8px';
                    spellingTip.style.backgroundColor = '#f0fff4';
                    spellingTip.style.borderLeft = '4px solid #27ae60';
                    spellingTip.style.borderRadius = '4px';
                    
                    // æ·»åŠ åˆ°ç­”æ¡ˆè¾“å…¥æ¡†åé¢
                    answerInput.parentNode.appendChild(spellingTip);
                    
                    // 3ç§’åè‡ªåŠ¨ç§»é™¤æç¤º
                    setTimeout(() => {
                        if (spellingTip.parentNode) {
                            spellingTip.parentNode.removeChild(spellingTip);
                        }
                    }, 3000);
                }
            } else {
                // ç­”æ¡ˆé”™è¯¯
                consecutiveCorrect = 0; // é‡ç½®è¿ç»­æ­£ç¡®æ¬¡æ•°
                updateLumiReaction('wrong');
                
                // å¦‚æœå¯ç”¨äº†å³æ—¶åé¦ˆï¼Œæ˜¾ç¤ºé”™è¯¯åé¦ˆå’Œæ­£ç¡®ç­”æ¡ˆ
                if (instantFeedbackEnabled) {
                    const feedbackEl = document.createElement('div');
                    feedbackEl.className = 'text-feedback';
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤ºæ‰€æœ‰å¯èƒ½çš„æ‹¼å†™å½¢å¼
                    let formattedSpellings;
                    if (correctSpelling.includes('/') || correctSpelling.includes(',')) {
                        // å¦‚æœåŸå§‹æ‹¼å†™åŒ…å«åˆ†éš”ç¬¦ï¼Œåˆ™æ˜¾ç¤ºæ‰€æœ‰æœ‰æ•ˆæ‹¼å†™
                        formattedSpellings = validSpellings
                            .map(s => `<span class="spelling-variant">${s}</span>`)
                            .join(' æˆ– ');
                    } else {
                        // å¦åˆ™ç›´æ¥æ˜¾ç¤ºåŸå§‹æ‹¼å†™
                        formattedSpellings = `<strong>${correctSpelling}</strong>`;
                    }
                    
                    feedbackEl.innerHTML = `<span style="color: #c0392b">âœ— é”™è¯¯!</span> æ­£ç¡®æ‹¼å†™: ${formattedSpellings}`;
                    feedbackEl.style.marginTop = '10px';
                    feedbackEl.style.padding = '8px';
                    feedbackEl.style.backgroundColor = '#fff0f0';
                    feedbackEl.style.borderLeft = '4px solid #c0392b';
                    feedbackEl.style.borderRadius = '4px';
                    answerInput.parentNode.appendChild(feedbackEl);
                }
            }

            userAnswers.push({
                word_id: questions[currentQuestionIndex].word_id,
                answer: answerInput.value
            });
            
            currentQuestionIndex++;
            answerInput.value = '';

            // ç«‹å³æ˜¾ç¤ºä¸‹ä¸€é¢˜ï¼Œç§»é™¤æ–‡å­—åé¦ˆæç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
            const textFeedback = document.querySelector('.text-feedback');
            if (textFeedback) {
                textFeedback.parentNode.removeChild(textFeedback);
            }
            
            if (currentQuestionIndex < questions.length) {
                displayQuestion();
                updateLumiReaction('thinking');
            } else {
                submitTest();
            }
        }

        // æäº¤æµ‹è¯•
        async function submitTest() {
            updateLumiReaction('celebration'); // æµ‹è¯•å®Œæˆï¼Œåº†ç¥ä¸€ä¸‹
            quizArea.style.display = 'none';
            const response = await fetch('/api/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ answers: userAnswers })
            });
            const results = await response.json();
            displayResults(results);
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const studyMode = document.getElementById('study-mode').value;
            resultsArea.style.display = 'block';
            document.getElementById('error-count').textContent = results.error_count;
            const errorListEl = document.getElementById('error-list');
            errorListEl.innerHTML = '';

            // é”™è¯å¤ä¹ æ¨¡å¼ç‰¹æ®Šå¤„ç†
            if (studyMode === 'error_review') {
                const correctCount = questions.length - results.error_count;
                const accuracyRate = Math.round((correctCount / questions.length) * 100);
                
                // æ·»åŠ é”™è¯å¤ä¹ æ¨¡å¼çš„ç‰¹æ®Šæ ‡é¢˜
                const reviewTitle = document.createElement('h3');
                reviewTitle.style.color = '#856404';
                reviewTitle.style.marginBottom = '15px';
                reviewTitle.innerHTML = `ğŸ“š é”™è¯å¤ä¹ ç»“æœ`;
                resultsArea.insertBefore(reviewTitle, resultsArea.firstChild);
                
                // æ·»åŠ ç»Ÿè®¡ä¿¡æ¯
                const statsDiv = document.createElement('div');
                statsDiv.style.cssText = `
                    background-color: #fff3cd;
                    border: 1px solid #ffeaa7;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 15px 0;
                    color: #856404;
                `;
                statsDiv.innerHTML = `
                    <p><strong>æœ¬æ¬¡å¤ä¹ ç»Ÿè®¡ï¼š</strong></p>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>å¤ä¹ å•è¯æ•°ï¼š<strong>${questions.length}</strong> ä¸ª</li>
                        <li>æ­£ç¡®æ•°é‡ï¼š<strong>${correctCount}</strong> ä¸ª</li>
                        <li>é”™è¯¯æ•°é‡ï¼š<strong>${results.error_count}</strong> ä¸ª</li>
                        <li>æ­£ç¡®ç‡ï¼š<strong>${accuracyRate}%</strong></li>
                    </ul>
                `;
                resultsArea.insertBefore(statsDiv, errorListEl);
                
                // æ ¹æ®æ­£ç¡®ç‡ç»™å‡ºä¸åŒçš„é¼“åŠ±ä¿¡æ¯
                let encouragement = '';
                if (accuracyRate === 100) {
                    encouragement = 'ğŸ‰ å®Œç¾ï¼ä½ å·²ç»å®Œå…¨æŒæ¡äº†è¿™äº›é”™è¯ï¼';
                } else if (accuracyRate >= 80) {
                    encouragement = 'ğŸ‘ å¾ˆå¥½ï¼å¤§éƒ¨åˆ†é”™è¯éƒ½å·²ç»æŒæ¡äº†ï¼Œç»§ç»­åŠ æ²¹ï¼';
                } else if (accuracyRate >= 60) {
                    encouragement = 'ğŸ’ª ä¸é”™ï¼æœ‰è¿›æ­¥ï¼Œä½†è¿˜éœ€è¦ç»§ç»­ç»ƒä¹ ã€‚';
                } else {
                    encouragement = 'ğŸ“– ç»§ç»­åŠªåŠ›ï¼è¿™äº›å•è¯è¿˜éœ€è¦æ›´å¤šç»ƒä¹ ã€‚';
                }
                
                const encouragementDiv = document.createElement('div');
                encouragementDiv.style.cssText = `
                    background-color: #d4edda;
                    border: 1px solid #c3e6cb;
                    border-radius: 8px;
                    padding: 10px;
                    margin: 10px 0;
                    color: #155724;
                    text-align: center;
                    font-weight: bold;
                `;
                encouragementDiv.textContent = encouragement;
                resultsArea.insertBefore(encouragementDiv, errorListEl);
            }

            if (results.error_details && results.error_details.length > 0) {
                results.error_details.forEach(err => {
                    const li = document.createElement('li');
                    
                    // å¤„ç†æ–œæ åˆ†éš”çš„æ‹¼å†™å˜ä½“
                    const slashSpellings = err.correct_spelling.split('/');
                    
                    // å¤„ç†é€—å·åˆ†éš”çš„æ‹¼å†™å˜ä½“
                    let allSpellings = [];
                    slashSpellings.forEach(spelling => {
                        if (spelling.includes(',')) {
                            // å¯¹äºé€—å·åˆ†éš”çš„å˜ä½“ï¼Œå°†å®ƒä»¬åˆ†å¼€å¹¶æ·»åŠ åˆ°æ‹¼å†™åˆ—è¡¨ä¸­
                            const commaVariants = spelling.split(',').map(v => v.trim());
                            allSpellings = allSpellings.concat(commaVariants);
                        } else {
                            allSpellings.push(spelling.trim());
                        }
                    });
                    
                    let correctSpellingDisplay = '';
                    
                    if (allSpellings.length > 1) {
                        // å¦‚æœæœ‰å¤šç§æ‹¼å†™å½¢å¼ï¼Œä»¥æ›´å‹å¥½çš„æ–¹å¼æ˜¾ç¤º
                        correctSpellingDisplay = allSpellings.map(s => `<span class="spelling-variant">${s}</span>`).join(' æˆ– ');
                        li.innerHTML = `<strong>æ­£ç¡®æ‹¼å†™:</strong> ${correctSpellingDisplay} / <strong>ä½ çš„ç­”æ¡ˆ:</strong> <span style="color: #c0392b;">${err.your_answer}</span>`;
                    } else {
                        // å•ä¸€æ‹¼å†™å½¢å¼
                        li.innerHTML = `<strong>æ­£ç¡®:</strong> ${err.correct_spelling} / <strong>ä½ çš„ç­”æ¡ˆ:</strong> <span style="color: #c0392b;">${err.your_answer}</span>`;
                    }
                    
                    errorListEl.appendChild(li);
                });
            } else {
                const li = document.createElement('li');
                li.innerHTML = 'ğŸ‰ æ­å–œä½ ï¼Œå…¨éƒ¨æ­£ç¡®ï¼å¤ªæ£’äº†ï¼';
                li.style.borderLeftColor = '#27ae60';
                li.style.background = '#f0fff4';
                errorListEl.appendChild(li);
            }

            if (!document.getElementById('back-btn')) {
                const backBtn = document.createElement('button');
                backBtn.id = 'back-btn';
                backBtn.textContent = studyMode === 'error_review' ? 'ç»§ç»­å¤ä¹ å…¶ä»–é”™è¯' : 'è¿”å›å¼€å§‹ç•Œé¢';
                backBtn.style.marginTop = '20px';
                backBtn.onclick = function() { 
                    if (studyMode === 'error_review') {
                        // é”™è¯å¤ä¹ æ¨¡å¼ï¼šé‡æ–°åŠ è½½é”™è¯
                        location.reload();
                    } else {
                        location.reload(); 
                    }
                };
                resultsArea.appendChild(backBtn);
            }
        }

        // --- äº‹ä»¶ç›‘å¬å™¨ ---
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            Object.values(lumiImages).forEach(path => { (new Image()).src = path; }); // é¢„åŠ è½½å›¾ç‰‡
            updateLumiReaction('welcome');
            loadBookLists(); // åŠ è½½è¯ä¹¦åˆ—è¡¨ï¼Œè€Œä¸æ˜¯ç›´æ¥åŠ è½½å•è¯åˆ—è¡¨
            checkLoginStatus();
            
            // åˆå§‹åŒ–é”™è¯å¤ä¹ æ¨¡å¼çš„è®¾ç½®
            const selectedMode = document.getElementById('study-mode').value;
            if (selectedMode === 'error_review') {
                const countSelectContainer = document.querySelector('.list-selector div:nth-child(3)');
                const countSelect = document.getElementById('count-select');
                countSelectContainer.style.display = 'none';
                countSelect.value = 'all';
            }
            
            // åˆå§‹åŒ–Lumiå¼€å…³çŠ¶æ€
            lumiEnabled = lumiToggle.checked;
            if (!lumiEnabled) {
                lumiImg.classList.remove('active');
            }
            
            // åˆå§‹æ£€æŸ¥ Lumi ä½ç½®
            checkLumiPosition();
            
            // æ·»åŠ çª—å£å¤§å°å˜åŒ–äº‹ä»¶ç›‘å¬å™¨
            window.addEventListener('resize', checkLumiPosition);
            
            // åˆå§‹åŒ–è‡ªåŠ¨æ’­æ”¾å¼€å…³çŠ¶æ€
            autoPlayEnabled = autoPlayToggle.checked;
            
            // åˆå§‹åŒ–é”™è¯æ¸…é›¶æ¨¡å¼å¼€å…³çŠ¶æ€
            errorClearModeEnabled = errorClearModeToggle.checked;
            
            // æ·»åŠ è¯ä¹¦é€‰æ‹©å˜åŒ–äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('book-select').addEventListener('change', function() {
                const selectedBookId = this.value;
                if (selectedBookId) {
                    loadWordLists(selectedBookId);
                } else {
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©è¯ä¹¦ï¼Œæ¸…ç©ºå•å…ƒåˆ—è¡¨
                    document.getElementById('list-select').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©è¯ä¹¦...</option>';
                }
                // æ–°å¢ï¼šåˆ‡æ¢è¯ä¹¦æ—¶ï¼Œå¦‚æœæ˜¯é”™è¯å¤ä¹ æ¨¡å¼ï¼Œåˆ·æ–°é”™è¯ç»Ÿè®¡åŒº
                const selectedMode = document.getElementById('study-mode').value;
                if (selectedMode === 'error_review') {
                    const errorStatsContent = document.getElementById('error-stats-content');
                    errorStatsContent.innerHTML = '<p style="color: #856404;">æ­£åœ¨åŠ è½½é”™è¯ç»Ÿè®¡...</p>';
                    loadErrorStats();
                }
            });
            
            // æ·»åŠ è®¤è¯ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
            loginBtn.addEventListener('click', handleLogin);
            
            // æ·»åŠ å›è½¦é”®ç™»å½•åŠŸèƒ½
            loginPassword.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleLogin();
                }
            });
            
            loginUsername.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleLogin();
                }
            });
            registerBtn.addEventListener('click', handleRegister);
            
            // æ˜¾ç¤ºæ³¨å†Œè¡¨å•ï¼Œéšè—ç™»å½•è¡¨å•
            showRegisterLink.addEventListener('click', function(e) {
                e.preventDefault();
                
                // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                loginForm.classList.add('fade-out');
                
                // ç­‰å¾…åŠ¨ç”»å®Œæˆååˆ‡æ¢è¡¨å•
                setTimeout(function() {
                    loginForm.style.display = 'none';
                    loginForm.classList.remove('fade-out');
                    
                    // æ˜¾ç¤ºæ³¨å†Œè¡¨å•å¹¶æ·»åŠ æ·¡å…¥åŠ¨ç”»
                    registerForm.style.display = 'block';
                }, 300);
            });
            
            // æ˜¾ç¤ºç™»å½•è¡¨å•ï¼Œéšè—æ³¨å†Œè¡¨å•
            showLoginLink.addEventListener('click', function(e) {
                e.preventDefault();
                
                // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                registerForm.classList.add('fade-out');
                
                // ç­‰å¾…åŠ¨ç”»å®Œæˆååˆ‡æ¢è¡¨å•
                setTimeout(function() {
                    registerForm.style.display = 'none';
                    registerForm.classList.remove('fade-out');
                    
                    // æ˜¾ç¤ºç™»å½•è¡¨å•å¹¶æ·»åŠ æ·¡å…¥åŠ¨ç”»
                    loginForm.style.display = 'block';
                }, 300);
            });
            logoutBtn.addEventListener('click', handleLogout);
        });
        
        // Lumiå¼€å…³äº‹ä»¶ç›‘å¬
        lumiToggle.addEventListener('change', function() {
            lumiEnabled = this.checked;
            if (lumiEnabled) {
                // æ ¹æ®å½“å‰çŠ¶æ€æ›´æ–° Lumi ååº”
                if (appContainer.style.display === 'block') {
                    // å¦‚æœåœ¨åº”ç”¨ç•Œé¢
                    if (quizArea.style.display === 'block' && currentQuestionIndex < questions.length) {
                        updateLumiReaction('thinking');
                    } else if (resultsArea.style.display === 'block') {
                        updateLumiReaction('celebration');
                    } else {
                        updateLumiReaction('welcome');
                    }
                } else {
                    updateLumiReaction('welcome');
                }
            } else {
                lumiImg.classList.remove('active');
            }
        });
        
        // è‡ªåŠ¨æ’­æ”¾å¼€å…³äº‹ä»¶ç›‘å¬
        autoPlayToggle.addEventListener('change', function() {
            autoPlayEnabled = this.checked;
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('autoPlayEnabled', autoPlayEnabled);
            // å¦‚æœå¼€å¯è‡ªåŠ¨æ’­æ”¾ä¸”å½“å‰æ­£åœ¨æ˜¾ç¤ºé—®é¢˜ï¼Œåˆ™ç«‹å³æ’­æ”¾å½“å‰é—®é¢˜çš„éŸ³é¢‘
            if (autoPlayEnabled && questions.length > 0 && currentQuestionIndex < questions.length && quizArea.style.display !== 'none') {
                autoPlayAudios();
            }
        });
        
        // å³æ—¶åé¦ˆå¼€å…³äº‹ä»¶ç›‘å¬
        document.getElementById('instant-feedback-toggle').addEventListener('change', function() {
            instantFeedbackEnabled = this.checked;
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('instantFeedbackEnabled', instantFeedbackEnabled);
        });

        // é”™è¯æ¸…é›¶æ¨¡å¼å¼€å…³äº‹ä»¶ç›‘å¬
        document.getElementById('error-clear-mode-toggle').addEventListener('change', function() {
            errorClearModeEnabled = this.checked;
            if (errorClearModeEnabled) {
                // å¦‚æœå¼€å¯é”™è¯æ¸…é›¶æ¨¡å¼ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°é”™è¯å¤ä¹ æ¨¡å¼
                document.getElementById('study-mode').value = 'error_review';
                // è§¦å‘å­¦ä¹ æ¨¡å¼å˜åŒ–äº‹ä»¶
                document.getElementById('study-mode').dispatchEvent(new Event('change'));
            } else {
                // å¦‚æœå…³é—­é”™è¯æ¸…é›¶æ¨¡å¼ï¼Œé‡æ–°åŠ è½½é”™è¯ç»Ÿè®¡ä»¥ç§»é™¤ç‰¹æ®Šæç¤º
                const selectedMode = document.getElementById('study-mode').value;
                if (selectedMode === 'error_review') {
                    loadErrorStats();
                }
            }
        });

        // å­¦ä¹ æ¨¡å¼å˜åŒ–äº‹ä»¶ç›‘å¬
        document.getElementById('study-mode').addEventListener('change', function() {
            const selectedMode = this.value;
            const errorStatsContainer = document.getElementById('error-stats-container');
            const countSelectContainer = document.querySelector('.list-selector div:nth-child(3)'); // æ•°é‡é€‰æ‹©å™¨å®¹å™¨
            const countSelect = document.getElementById('count-select');
            
            if (selectedMode === 'error_review') {
                // æ˜¾ç¤ºé”™è¯ç»Ÿè®¡å®¹å™¨
                errorStatsContainer.style.display = 'block';
                // éšè—æ•°é‡é€‰æ‹©å™¨
                countSelectContainer.style.display = 'none';
                // é»˜è®¤é€‰æ‹©å…¨éƒ¨
                countSelect.value = 'all';
                // åŠ è½½é”™è¯ç»Ÿè®¡ä¿¡æ¯
                loadErrorStats();
                
                // å¦‚æœé”™è¯æ¸…é›¶æ¨¡å¼å·²å¼€å¯ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
                if (errorClearModeEnabled) {
                    const errorStatsContent = document.getElementById('error-stats-content');
                    if (errorStatsContent) {
                        const clearModeNote = document.createElement('div');
                        clearModeNote.style.cssText = `
                            background: #e3f2fd;
                            border: 1px solid #2196f3;
                            border-radius: 5px;
                            padding: 10px;
                            margin-top: 10px;
                            color: #1976d2;
                            font-weight: bold;
                        `;
                        clearModeNote.innerHTML = 'ğŸ¯ <strong>é”™è¯æ¸…é›¶æ¨¡å¼å·²å¼€å¯</strong> - å°†å¯¹é”™è¯è¿›è¡Œå¾ªç¯è€ƒæ ¸ç›´åˆ°100%æ­£ç¡®ï¼';
                        errorStatsContent.appendChild(clearModeNote);
                    }
                }
            } else {
                // éšè—é”™è¯ç»Ÿè®¡å®¹å™¨
                errorStatsContainer.style.display = 'none';
                // æ˜¾ç¤ºæ•°é‡é€‰æ‹©å™¨
                countSelectContainer.style.display = 'block';
                
                // å¦‚æœåˆ‡æ¢åˆ°å…¶ä»–æ¨¡å¼ï¼Œå…³é—­é”™è¯æ¸…é›¶æ¨¡å¼
                if (errorClearModeEnabled) {
                    errorClearModeToggle.checked = false;
                    errorClearModeEnabled = false;
                }
            }
        });

        // å•å…ƒé€‰æ‹©å˜åŒ–äº‹ä»¶ç›‘å¬ï¼ˆç”¨äºé”™è¯å¤ä¹ æ¨¡å¼ï¼‰
        document.getElementById('list-select').addEventListener('change', function() {
            const selectedMode = document.getElementById('study-mode').value;
            if (selectedMode === 'error_review') {
                // ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const errorStatsContent = document.getElementById('error-stats-content');
                errorStatsContent.innerHTML = '<p style="color: #856404;">æ­£åœ¨åŠ è½½é”™è¯ç»Ÿè®¡...</p>';
                
                // ç«‹å³åŠ è½½é”™è¯ç»Ÿè®¡ä¿¡æ¯
                loadErrorStats();
            }
        });

        // æ˜¾ç¤ºé”™è¯æ¸…é›¶æ¨¡å¼ç•Œé¢
        function showErrorClearModeInterface() {
            // åˆ›å»ºé”™è¯æ¸…é›¶æ¨¡å¼å®¹å™¨
            const errorClearContainer = document.createElement('div');
            errorClearContainer.id = 'error-clear-container';
            errorClearContainer.style.cssText = `
                max-width: 800px;
                margin: 0 auto;
                background: #ffffff;
                padding: 20px 40px;
                border-radius: 8px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            `;
            
            // åˆ›å»ºæ ‡é¢˜
            const title = document.createElement('h1');
            title.textContent = 'ã€é”™è¯æ¸…é›¶æ¨¡å¼ã€‘å†å²é”™è¯å¾ªç¯è€ƒæ ¸';
            title.style.cssText = `
                color: #b30000;
                border-bottom: 2px solid #e1e1e1;
                padding-bottom: 10px;
                text-align: center;
            `;
            
            // åˆ›å»ºè½®æ¬¡æ ‡é¢˜
            const roundTitle = document.createElement('h2');
            roundTitle.id = 'error-clear-round-title';
            roundTitle.style.cssText = `
                color: #b30000;
                border-bottom: 1px solid #e1e1e1;
                padding-bottom: 10px;
                text-align: center;
            `;
            
            // åˆ›å»ºè¯´æ˜
            const instructions = document.createElement('p');
            instructions.className = 'instructions';
            instructions.textContent = 'æœ¬æ¨¡å¼å°†å¯¹é”™è¯è¿›è¡Œå¾ªç¯è€ƒæ ¸ï¼Œç›´åˆ°æ­£ç¡®ç‡è¾¾åˆ°100%ï¼';
            instructions.style.cssText = `
                color: var(--text-color);
                font-size: 1.1em;
                background-color: var(--bg-color);
                border-left: 5px solid var(--primary-color);
                padding: 10px;
                margin: 20px 0;
            `;
            
            // åˆ›å»ºè¡¨å•
            const form = document.createElement('form');
            form.id = 'error-clear-form';
            
            // åˆ›å»ºå•è¯åˆ—è¡¨å®¹å™¨
            const wordListContainer = document.createElement('div');
            wordListContainer.id = 'error-clear-word-list';
            
            // åˆ›å»ºæäº¤æŒ‰é’®
            const submitBtn = document.createElement('button');
            submitBtn.type = 'submit';
            submitBtn.textContent = 'æäº¤ç­”æ¡ˆå¹¶è¿›å…¥ä¸‹ä¸€è½®';
            submitBtn.style.cssText = `
                margin-top: 20px;
                padding: 12px 25px;
                background: var(--primary-color);
                border: none;
                color: white;
                font-weight: bold;
                cursor: pointer;
                border-radius: 5px;
                font-size: 18px;
                display: block;
                width: 100%;
                transition: background-color 0.2s;
            `;
            submitBtn.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'var(--hover-color)';
            });
            submitBtn.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'var(--primary-color)';
            });
            
            // åˆ›å»ºç»“æœå®¹å™¨
            const resultContainer = document.createElement('div');
            resultContainer.id = 'error-clear-result';
            resultContainer.style.cssText = `
                margin-top: 30px;
                padding: 20px;
                background: var(--bg-color);
                border: 1px solid var(--primary-color);
                border-radius: 8px;
                display: none;
            `;
            
            // ç»„è£…ç•Œé¢
            form.appendChild(wordListContainer);
            form.appendChild(submitBtn);
            errorClearContainer.appendChild(title);
            errorClearContainer.appendChild(roundTitle);
            errorClearContainer.appendChild(instructions);
            errorClearContainer.appendChild(form);
            errorClearContainer.appendChild(resultContainer);
            
            // æ›¿æ¢ä¸»å®¹å™¨å†…å®¹
            const appContainer = document.getElementById('app-container');
            appContainer.innerHTML = '';
            appContainer.appendChild(errorClearContainer);
            
            // ç”Ÿæˆç¬¬ä¸€è½®è€ƒæ ¸
            generateErrorClearQuiz();
            
            // æ·»åŠ è¡¨å•æäº¤äº‹ä»¶
            form.addEventListener('submit', handleErrorClearSubmit);
        }

        // ç”Ÿæˆé”™è¯æ¸…é›¶æ¨¡å¼è€ƒæ ¸
        function generateErrorClearQuiz() {
            const wordListContainer = document.getElementById('error-clear-word-list');
            const roundTitle = document.getElementById('error-clear-round-title');
            const resultContainer = document.getElementById('error-clear-result');
            
            // æ¸…ç©ºå®¹å™¨
            wordListContainer.innerHTML = '';
            resultContainer.style.display = 'none';
            
            // æ›´æ–°æ ‡é¢˜
            const currentWords = errorClearModeData.currentQuestions;
            let titleText = `ç¬¬ ${errorClearModeData.currentRound} è½®è€ƒæ ¸ (å‰©ä½™ ${currentWords.length} è¯)`;
            if (errorClearModeData.currentRound === 1) {
                titleText = `é”™è¯æ¸…é›¶è€ƒæ ¸ (å…± ${currentWords.length} è¯)`;
            }
            roundTitle.textContent = titleText;
            
            // ç”Ÿæˆå•è¯åˆ—è¡¨
            currentWords.forEach((word, index) => {
                const wordBox = document.createElement('div');
                wordBox.className = 'word-box';
                wordBox.style.cssText = `
                    margin-bottom: 18px;
                    display: flex;
                    align-items: center;
                    flex-wrap: wrap;
                    padding: 10px 0;
                    border-bottom: 1px dashed #ccc;
                `;
                
                const inputId = `error-clear-word-${index}`;
                
                // åˆ›å»ºæ ‡ç­¾å®¹å™¨
                const tagContainer = document.createElement('div');
                tagContainer.style.cssText = `
                    display: block;
                    margin-bottom: 5px;
                `;
                
                // æ·»åŠ æ ‡ç­¾
                const bookTag = document.createElement('span');
                bookTag.textContent = `è¯ä¹¦: ${word.book_name}`;
                bookTag.style.cssText = `
                    font-size: 0.8em;
                    font-weight: bold;
                    color: #fff;
                    padding: 2px 8px;
                    border-radius: 10px;
                    margin-right: 6px;
                    white-space: nowrap;
                    background-color: #17a2b8;
                `;
                
                const listTag = document.createElement('span');
                listTag.textContent = `å•å…ƒ: ${word.list_name}`;
                listTag.style.cssText = `
                    font-size: 0.8em;
                    font-weight: bold;
                    color: #fff;
                    padding: 2px 8px;
                    border-radius: 10px;
                    margin-right: 6px;
                    white-space: nowrap;
                    background-color: #28a745;
                `;
                
                const countTag = document.createElement('span');
                countTag.textContent = `é”™è¿‡ ${word.error_count} æ¬¡`;
                countTag.style.cssText = `
                    font-size: 0.8em;
                    font-weight: bold;
                    color: #fff;
                    padding: 2px 8px;
                    border-radius: 10px;
                    margin-right: 6px;
                    white-space: nowrap;
                    background-color: #dc3545;
                `;
                
                const dateTag = document.createElement('span');
                dateTag.textContent = `ä¸Šæ¬¡: ${word.last_error_date}`;
                dateTag.style.cssText = `
                    font-size: 0.8em;
                    font-weight: bold;
                    color: #fff;
                    padding: 2px 8px;
                    border-radius: 10px;
                    margin-right: 6px;
                    white-space: nowrap;
                    background-color: #6c757d;
                `;
                
                tagContainer.appendChild(bookTag);
                tagContainer.appendChild(listTag);
                tagContainer.appendChild(countTag);
                tagContainer.appendChild(dateTag);
                
                // åˆ›å»ºæ ‡ç­¾
                const label = document.createElement('label');
                label.htmlFor = inputId;
                label.style.cssText = `
                    flex: 1;
                    min-width: 350px;
                    margin-right: 15px;
                    line-height: 1.5;
                `;
                
                const itemNum = document.createElement('span');
                itemNum.textContent = `${index + 1}. `;
                itemNum.style.cssText = `
                    font-weight: bold;
                    margin-right: 5px;
                    color: #005a9c;
                `;
                
                const pos = document.createElement('span');
                pos.textContent = word.pos || '';
                pos.style.cssText = `
                    font-style: italic;
                    color: #007bff;
                    font-weight: bold;
                `;
                
                const meaning = document.createElement('span');
                meaning.textContent = ` ${word.meaning_cn || ''}`;
                
                const ipa = document.createElement('span');
                // ä¼˜å…ˆä½¿ç”¨æ•°æ®åº“ä¸­çš„IPAå­—æ®µ
                const ipaText = word.ipa ? `/${word.ipa}/` : '';
                if (ipaText) {
                    ipa.textContent = ` [${ipaText}]`;
                    ipa.style.cssText = `
                        color: #d35400;
                        font-family: "Lucida Sans Unicode", sans-serif;
                        margin-left: 8px;
                    `;
                }
                
                label.appendChild(itemNum);
                label.appendChild(tagContainer);
                label.appendChild(pos);
                label.appendChild(meaning);
                label.appendChild(ipa);
                label.appendChild(document.createTextNode('ï¼š'));
                
                // åˆ›å»ºè¾“å…¥æ¡†
                const input = document.createElement('input');
                input.type = 'text';
                input.id = inputId;
                input.autocomplete = 'off';
                input.style.cssText = `
                    padding: 10px;
                    width: 220px;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    font-size: 16px;
                `;
                
                // æ·»åŠ é¼ æ ‡æ¿€æ´»æ—¶æ’­æ”¾éŸ³é¢‘çš„åŠŸèƒ½
                input.addEventListener('focus', () => {
                    if (word.audio_path_us || word.audio_path_uk) {
                        const audioPath = word.audio_path_us || word.audio_path_uk;
                        const audio = new Audio(`/wordlists/${audioPath}`);
                        audio.play().catch(e => {
                            console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e);
                            // TTS fallback
                            const ttsAudio = new Audio(`/api/tts/${word.spelling}`);
                            ttsAudio.play().catch(ttsError => console.log('TTSä¹Ÿå¤±è´¥:', ttsError));
                        });
                    } else {
                        // ç›´æ¥ä½¿ç”¨TTS
                        const ttsAudio = new Audio(`/api/tts/${word.spelling}`);
                        ttsAudio.play().catch(ttsError => console.log('TTSå¤±è´¥:', ttsError));
                    }
                });
                
                wordBox.appendChild(label);
                wordBox.appendChild(input);
                wordListContainer.appendChild(wordBox);
            });
            
            // èšç„¦ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
            if (wordListContainer.querySelector('input')) {
                wordListContainer.querySelector('input').focus();
            }
        }

        // å¤„ç†é”™è¯æ¸…é›¶æ¨¡å¼æäº¤
        function handleErrorClearSubmit(event) {
            event.preventDefault();
            
            const currentWords = errorClearModeData.currentQuestions;
            const incorrectWords = [];
            let correctCount = 0;
            const resultDetails = [];
            
            // æ£€æŸ¥æ¯ä¸ªç­”æ¡ˆ
            currentWords.forEach((word, index) => {
                const inputElement = document.getElementById(`error-clear-word-${index}`);
                const userAnswer = inputElement.value.trim();
                const correctAnswer = word.spelling;
                
                const resultLine = {
                    word: word.spelling,
                    userAnswer: userAnswer,
                    isCorrect: userAnswer.toLowerCase() === correctAnswer.toLowerCase()
                };
                
                if (resultLine.isCorrect) {
                    correctCount++;
                } else {
                    incorrectWords.push(word);
                    // è®°å½•é”™è¯¯åˆ°æ•°æ®åº“
                    recordError(word, userAnswer);
                }
                
                resultDetails.push(resultLine);
            });
            
            // ä¿å­˜æœ¬è½®ç»“æœ
            errorClearModeData.roundResults.push({
                round: errorClearModeData.currentRound,
                totalWords: currentWords.length,
                correctCount: correctCount,
                incorrectWords: [...incorrectWords],
                resultDetails: resultDetails
            });
            
            // æ˜¾ç¤ºæœ¬è½®ç»“æœ
            showErrorClearRoundResult();
            
            // å‡†å¤‡ä¸‹ä¸€è½®
            if (incorrectWords.length > 0) {
                errorClearModeData.currentQuestions = incorrectWords;
                errorClearModeData.currentRound++;
                
                // å»¶è¿Ÿæ˜¾ç¤ºä¸‹ä¸€è½®ï¼Œç»™ç”¨æˆ·è¶³å¤Ÿæ—¶é—´æŸ¥çœ‹ç»“æœ
                setTimeout(() => {
                    generateErrorClearQuiz();
                }, 5000); // å¢åŠ åˆ°5ç§’
            } else {
                // å…¨éƒ¨æ­£ç¡®ï¼Œæ˜¾ç¤ºå®Œæˆç•Œé¢
                setTimeout(() => {
                    showErrorClearCompletion();
                }, 5000); // å¢åŠ åˆ°5ç§’
            }
        }

        // æ˜¾ç¤ºé”™è¯æ¸…é›¶æ¨¡å¼è½®æ¬¡ç»“æœ
        function showErrorClearRoundResult() {
            const resultContainer = document.getElementById('error-clear-result');
            const currentRound = errorClearModeData.roundResults[errorClearModeData.roundResults.length - 1];
            
            const overallPercentage = Math.round((currentRound.correctCount / currentRound.totalWords) * 100);
            
            resultContainer.innerHTML = `
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">ç¬¬ ${currentRound.round} è½®ç»“æœ</h3>
                <div style="margin-bottom: 15px;">
                    <p><strong>æœ¬è½®ç»Ÿè®¡ï¼š</strong></p>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>æ€»å•è¯æ•°ï¼š<strong>${currentRound.totalWords}</strong> ä¸ª</li>
                        <li>æ­£ç¡®æ•°é‡ï¼š<strong>${currentRound.correctCount}</strong> ä¸ª</li>
                        <li>é”™è¯¯æ•°é‡ï¼š<strong>${currentRound.totalWords - currentRound.correctCount}</strong> ä¸ª</li>
                        <li>æ­£ç¡®ç‡ï¼š<strong>${overallPercentage}%</strong></li>
                    </ul>
                </div>
                <div style="margin-bottom: 15px;">
                    <p><strong>è¯¦ç»†ç»“æœï¼š</strong></p>
                    ${currentRound.resultDetails.map(detail => {
                        if (detail.isCorrect) {
                            return `<p style="color: var(--primary-color); font-weight: bold;">âœ” æ­£ç¡®: ${detail.word}</p>`;
                        } else {
                            return `<p>âœ˜ é”™è¯¯: "${detail.word}" â€” ä½ çš„ç­”æ¡ˆ: <span style="color: var(--error-color); text-decoration: line-through;">${detail.userAnswer || 'ï¼ˆæœªå¡«å†™ï¼‰'}</span></p>`;
                        }
                    }).join('')}
                </div>
            `;
            
            resultContainer.style.display = 'block';
        }

        // æ˜¾ç¤ºé”™è¯æ¸…é›¶æ¨¡å¼å®Œæˆç•Œé¢
        function showErrorClearCompletion() {
            const appContainer = document.getElementById('app-container');
            const totalRounds = errorClearModeData.roundResults.length;
            const totalWords = errorClearModeData.originalQuestions.length;
            
            appContainer.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; background: var(--bg-color); padding: 40px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center;">
                    <h1 style="color: var(--primary-color); margin-bottom: 20px;">ğŸ‰ æ­å–œï¼é”™è¯æ¸…é›¶å®Œæˆï¼</h1>
                    <div style="background: var(--bg-color); border: 1px solid var(--primary-color); border-radius: 8px; padding: 30px; margin: 20px 0;">
                        <h2 style="color: var(--text-color); margin-bottom: 15px;">å­¦ä¹ æˆæœæ€»ç»“</h2>
                        <ul style="text-align: left; margin: 20px 0; padding-left: 20px;">
                            <li>åŸå§‹é”™è¯æ•°é‡ï¼š<strong>${totalWords}</strong> ä¸ª</li>
                            <li>å®Œæˆè½®æ¬¡ï¼š<strong>${totalRounds}</strong> è½®</li>
                            <li>æœ€ç»ˆæ­£ç¡®ç‡ï¼š<strong>100%</strong></li>
                        </ul>
                    </div>
                    <div style="margin-top: 30px;">
                        <h3 style="color: var(--primary-color); margin-bottom: 15px;">å„è½®æ¬¡è¡¨ç°</h3>
                        ${errorClearModeData.roundResults.map((round, index) => {
                            const percentage = Math.round((round.correctCount / round.totalWords) * 100);
                            return `
                                <div style="background: var(--bg-color); border: 1px solid var(--primary-color); border-radius: 5px; padding: 10px; margin: 10px 0; text-align: left;">
                                    <strong>ç¬¬ ${round.round} è½®ï¼š</strong> ç­”å¯¹ ${round.correctCount} / ${round.totalWords} ä¸ªï¼Œæ­£ç¡®ç‡ ${percentage}%
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="margin-top: 30px;">
                        <button onclick="location.reload()" style="margin-right: 15px; padding: 12px 25px; background: var(--primary-color); border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.2s;">
                            è¿”å›å¼€å§‹ç•Œé¢
                        </button>
                        <button onclick="handleLogout()" style="padding: 12px 25px; background: var(--accent-color); border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.2s;">
                            é€€å‡ºç™»å½•
                        </button>
                    </div>
                    <div class="quiz-controls" style="position: static; margin-top: 30px; display: flex; justify-content: flex-end;">
                        <button id="back-home-btn-clear" class="control-btn" title="è¿”å›ä¸»é¡µ">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9,22 9,12 15,12 15,22"></polyline>
                            </svg>
                        </button>
                        <button id="exit-quiz-btn-clear" class="control-btn" title="é€€å‡ºæµ‹è¯•">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // è®°å½•é”™è¯¯åˆ°æ•°æ®åº“çš„å‡½æ•°
        async function recordError(word, userAnswer) {
            try {
                console.log('æ­£åœ¨è®°å½•é”™è¯¯:', {
                    word_id: word.word_id,
                    word_spelling: word.spelling,
                    student_answer: userAnswer,
                    list_id: word.list_id
                });
                
                const response = await fetch('/api/record-error', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        word_id: word.word_id,
                        student_answer: userAnswer,
                        list_id: word.list_id
                    })
                });
                
                if (!response.ok) {
                    console.error('è®°å½•é”™è¯¯å¤±è´¥:', response.statusText);
                    const errorData = await response.text();
                    console.error('é”™è¯¯è¯¦æƒ…:', errorData);
                } else {
                    const result = await response.json();
                    console.log('é”™è¯¯è®°å½•æˆåŠŸ:', result);
                }
            } catch (error) {
                console.error('è®°å½•é”™è¯¯æ—¶å‡ºé”™:', error);
            }
        }

        // ä¿å­˜å½“å‰æµ‹è¯•è¿›åº¦çš„å‡½æ•°
        async function saveQuizProgress() {
            if (userAnswers.length === 0) return;
            
            try {
                const progress = {
                    list_id: document.getElementById('list-select').value,
                    study_mode: document.getElementById('study-mode').value,
                    total_questions: questions.length,
                    answered_questions: userAnswers.length,
                    correct_answers: userAnswers.filter(answer => answer.isCorrect).length,
                    progress_percentage: Math.round((userAnswers.length / questions.length) * 100),
                    timestamp: new Date().toISOString()
                };
                
                // ä¿å­˜åˆ°localStorageä½œä¸ºå¤‡ä»½
                localStorage.setItem('quizProgress', JSON.stringify(progress));
                
                console.log('æµ‹è¯•è¿›åº¦å·²ä¿å­˜:', progress);
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€åˆ°æœåŠ¡å™¨çš„é€»è¾‘
                // const response = await fetch('/api/save-progress', {
                //     method: 'POST',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify(progress)
                // });
                
            } catch (error) {
                console.error('ä¿å­˜è¿›åº¦æ—¶å‡ºé”™:', error);
            }
        }

        // åŠ è½½é”™è¯ç»Ÿè®¡ä¿¡æ¯çš„å‡½æ•°
        async function loadErrorStats() {
            const selectedListId = document.getElementById('list-select').value;
            const errorStatsContent = document.getElementById('error-stats-content');
            
            if (!selectedListId) {
                errorStatsContent.innerHTML = '<p style="color: #856404;">è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå•è¯åˆ—è¡¨</p>';
                return;
            }
            
            // ç«‹å³æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            errorStatsContent.innerHTML = '<p style="color: #856404;">æ­£åœ¨åŠ è½½é”™è¯ç»Ÿè®¡...</p>';
            
            try {
                const response = await fetch(`/api/error-stats?list_id=${selectedListId}`);
                if (!response.ok) {
                    if (response.status === 401) {
                        errorStatsContent.innerHTML = '<p style="color: #dc3545;">è¯·å…ˆç™»å½•åæŸ¥çœ‹é”™è¯ç»Ÿè®¡</p>';
                    } else {
                        throw new Error('è·å–é”™è¯ç»Ÿè®¡å¤±è´¥');
                    }
                    return;
                }
                
                const stats = await response.json();
                
                if (stats.error_words_count === 0) {
                    errorStatsContent.innerHTML = `
                        <p style="color: #28a745; font-weight: bold;">ğŸ‰ æ­å–œï¼</p>
                        <p style="color: #28a745;">åœ¨ <strong>${stats.book_name} - ${stats.list_name}</strong> ä¸­ï¼Œä½ è¿˜æ²¡æœ‰çŠ¯è¿‡ä»»ä½•é”™è¯¯ï¼</p>
                        <p style="color: #6c757d; font-size: 0.9em;">ç»§ç»­ä¿æŒï¼Œæˆ–è€…å°è¯•å…¶ä»–æ¨¡å¼æ¥æŒ‘æˆ˜è‡ªå·±ã€‚</p>
                    `;
                } else {
                    errorStatsContent.innerHTML = `
                        <p style="color: #856404;">åœ¨ <strong>${stats.book_name} - ${stats.list_name}</strong> ä¸­ï¼š</p>
                        <ul style="margin: 5px 0; padding-left: 20px;">
                            <li>é”™è¯æ•°é‡ï¼š<strong>${stats.error_words_count}</strong> ä¸ª</li>
                            <li>æ€»é”™è¯¯æ¬¡æ•°ï¼š<strong>${stats.total_errors}</strong> æ¬¡</li>
                        </ul>
                        <p style="color: #856404; font-size: 0.9em; margin-top: 10px;">
                            é”™è¯å¤ä¹ æ¨¡å¼å°†å¸®åŠ©ä½ é‡ç‚¹ç»ƒä¹ è¿™äº›å®¹æ˜“å‡ºé”™çš„å•è¯ï¼Œç›´åˆ°å®Œå…¨æŒæ¡ï¼
                        </p>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½é”™è¯ç»Ÿè®¡æ—¶å‡ºé”™:', error);
                errorStatsContent.innerHTML = '<p style="color: #dc3545;">åŠ è½½é”™è¯ç»Ÿè®¡æ—¶å‡ºé”™ï¼Œè¯·ç¨åå†è¯•</p>';
            }
        }

        // å¼€å§‹æŒ‰é’®
        startBtn.addEventListener('click', async () => {
            const selectedListId = document.getElementById('list-select').value;
            const selectedCount = document.getElementById('count-select').value;
            const selectedMode = document.getElementById('study-mode').value;
            
            if (!selectedListId) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå•è¯åˆ—è¡¨ï¼');
                return;
            }

            // é”™è¯å¤ä¹ æ¨¡å¼ç‰¹æ®Šå¤„ç†
            if (selectedMode === 'error_review') {
                try {
                    // å…ˆæ£€æŸ¥é”™è¯ç»Ÿè®¡
                    const statsResponse = await fetch(`/api/error-stats?list_id=${selectedListId}`);
                    if (!statsResponse.ok) {
                        if (statsResponse.status === 401) {
                            alert('è¯·å…ˆç™»å½•åä½¿ç”¨é”™è¯å¤ä¹ æ¨¡å¼ï¼');
                            return;
                        } else {
                            throw new Error('è·å–é”™è¯ç»Ÿè®¡å¤±è´¥');
                        }
                    }
                    
                    const stats = await statsResponse.json();
                    if (stats.error_words_count === 0) {
                        alert('æ­å–œï¼åœ¨è¿™ä¸ªåˆ—è¡¨ä¸­ä½ è¿˜æ²¡æœ‰çŠ¯è¿‡ä»»ä½•é”™è¯¯ã€‚è¯·å°è¯•å…¶ä»–æ¨¡å¼æˆ–é€‰æ‹©å…¶ä»–åˆ—è¡¨ã€‚');
                        return;
                    }
                } catch (error) {
                    console.error("æ£€æŸ¥é”™è¯ç»Ÿè®¡æ—¶å‡ºé”™:", error);
                    alert('æ£€æŸ¥é”™è¯ç»Ÿè®¡æ—¶å‡ºé”™ï¼Œè¯·ç¨åå†è¯•');
                    return;
                }
            }

            try {
                // é”™è¯æ¸…é›¶æ¨¡å¼å¼ºåˆ¶ä½¿ç”¨é”™è¯å¤ä¹ æ¨¡å¼
                const actualStudyMode = errorClearModeEnabled ? 'error_review' : selectedMode;
                const response = await fetch(`/api/questions?list_id=${selectedListId}&count=${selectedCount}&study_mode=${actualStudyMode}`);
                if (!response.ok) {
                    if (response.status === 401) {
                        alert('è¯·å…ˆç™»å½•åä½¿ç”¨æ­¤åŠŸèƒ½ï¼');
                        return;
                    }
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }
                questions = await response.json();
                
                if (questions && questions.length > 0) {
                    // é”™è¯æ¸…é›¶æ¨¡å¼ç‰¹æ®Šå¤„ç†
                    if (errorClearModeEnabled) {
                        // åˆå§‹åŒ–é”™è¯æ¸…é›¶æ¨¡å¼æ•°æ®
                        errorClearModeData = {
                            isActive: true,
                            currentRound: 1,
                            originalQuestions: [...questions],
                            currentQuestions: [...questions],
                            incorrectWords: [],
                            roundResults: []
                        };
                        
                        // éšè—æ‰€æœ‰æ§åˆ¶å…ƒç´ 
                        document.querySelector('.list-selector').style.display = 'none';
                        startBtn.style.display = 'none';
                        document.querySelector('a.btn').style.display = 'none';
                        document.getElementById('error-stats-container').style.display = 'none';
                        document.querySelector('.lumi-toggle-container').style.display = 'none';
                        document.querySelector('.auto-play-container').style.display = 'none';
                        document.querySelector('.feedback-container').style.display = 'none';
                        document.querySelector('.error-clear-mode-container').style.display = 'none';
                        
                        // æ˜¾ç¤ºé”™è¯æ¸…é›¶æ¨¡å¼ç•Œé¢
                        showErrorClearModeInterface();
                    } else {
                        // æ ‡å‡†æ¨¡å¼
                        document.querySelector('.list-selector').style.display = 'none';
                        startBtn.style.display = 'none';
                        document.querySelector('a.btn').style.display = 'none';
                        document.getElementById('error-stats-container').style.display = 'none';
                        quizArea.style.display = 'block';
                        totalQNumEl.textContent = questions.length;
                        userAnswers = []; // é‡ç½®ç­”æ¡ˆ
                        currentQuestionIndex = 0; // é‡ç½®ç´¢å¼•
                        inputEnabled = true; // é‡ç½®è¾“å…¥çŠ¶æ€
                        displayQuestion();
                        updateLumiReaction('thinking');
                    }
                } else {
                    if (selectedMode === 'error_review') {
                        alert('è¯¥åˆ—è¡¨ä¸­æ²¡æœ‰é”™è¯éœ€è¦å¤ä¹ ï¼');
                    } else {
                        alert('æ— æ³•åŠ è½½é¢˜ç›®æˆ–è¯¥åˆ—è¡¨ä¸ºç©ºï¼');
                    }
                }
            } catch (error) {
                console.error("åŠ è½½é¢˜ç›®æ—¶å‡ºé”™:", error);
                alert('åŠ è½½é¢˜ç›®æ—¶å‡ºé”™ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ã€‚');
            }
        });

        // é€€å‡ºæµ‹è¯•æŒ‰é’®
        document.addEventListener('click', function(e) {
            if (e.target.id === 'exit-quiz-btn') {
                if (confirm('ç¡®å®šè¦é€€å‡ºå½“å‰æµ‹è¯•å—ï¼Ÿ\n\nâš ï¸ è­¦å‘Šï¼š\nâ€¢ å½“å‰è¿›åº¦å°†ä¸¢å¤±\nâ€¢ å·²ç­”é¢˜ç›®ä¸ä¼šä¿å­˜\nâ€¢ éœ€è¦é‡æ–°å¼€å§‹æµ‹è¯•\n\næ˜¯å¦ç»§ç»­é€€å‡ºï¼Ÿ')) {
                    // ä¿å­˜å½“å‰è¿›åº¦
                    if (userAnswers.length > 0) {
                        saveQuizProgress();
                        console.log('å·²ç­”é¢˜ç›®æ•°é‡:', userAnswers.length);
                    }
                    
                    // é‡ç½®æµ‹è¯•çŠ¶æ€
                    resetQuizState();
                }
            }
        });

        // è¿”å›ä¸»é¡µæŒ‰é’®
        document.addEventListener('click', function(e) {
            if (e.target.id === 'back-home-btn' || e.target.id === 'back-home-from-clear-btn') {
                if (confirm('ç¡®å®šè¦è¿”å›ä¸»é¡µå—ï¼Ÿ\n\nå½“å‰æµ‹è¯•è¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                    // ä¿å­˜å½“å‰è¿›åº¦
                    if (userAnswers.length > 0) {
                        saveQuizProgress();
                    }
                    
                    resetQuizState();
                }
            }
        });

        // é‡ç½®æµ‹è¯•çŠ¶æ€çš„å‡½æ•°
        function resetQuizState() {
            // é‡ç½®æ‰€æœ‰å˜é‡
            questions = [];
            currentQuestionIndex = 0;
            userAnswers = [];
            consecutiveCorrect = 0;
            inputEnabled = true; // é‡ç½®è¾“å…¥çŠ¶æ€
            errorClearModeData = {
                isActive: false,
                currentRound: 1,
                originalQuestions: [],
                currentQuestions: [],
                incorrectWords: [],
                roundResults: []
            };
            
            // æ˜¾ç¤ºæ‰€æœ‰æ§åˆ¶å…ƒç´ 
            document.querySelector('.list-selector').style.display = 'flex';
            startBtn.style.display = 'inline-block';
            document.querySelector('a.btn').style.display = 'inline-flex';
            document.getElementById('error-stats-container').style.display = 'block';
            document.querySelector('.lumi-toggle-container').style.display = 'flex';
            document.querySelector('.auto-play-container').style.display = 'flex';
            document.querySelector('.feedback-container').style.display = 'flex';
            document.querySelector('.error-clear-mode-container').style.display = 'flex';
            
            // éšè—æµ‹è¯•åŒºåŸŸ
            quizArea.style.display = 'none';
            resultsArea.style.display = 'none';
            
            // æ¸…ç©ºè¾“å…¥æ¡†å’Œé—®é¢˜æ˜¾ç¤º
            answerInput.value = '';
            questionMeaningEl.textContent = '';
            questionIpaEl.textContent = '';
            questionMeaningEnEl.textContent = '';
            questionExampleEnEl.textContent = '';
            questionExampleCnEl.textContent = '';
            
            // é‡ç½®è¯¦æƒ…åŒºåŸŸ
            wordDetailsContainer.style.display = 'none';
            toggleDetailsBtn.textContent = 'æ˜¾ç¤ºæ›´å¤šè¯¦æƒ…';
            
            // æ¸…ç©ºè¯¦æƒ…å†…å®¹
            questionDerivativesEl.textContent = '';
            questionRootEtymologyEl.textContent = '';
            questionMnemonicEl.textContent = '';
            questionComparisonEl.textContent = '';
            questionCollocationEl.textContent = '';
            questionExamSentenceEl.textContent = '';
            questionExamYearSourceEl.textContent = '';
            questionExamOptionsEl.textContent = '';
            questionExamExplanationEl.textContent = '';
            questionTipsEl.textContent = '';
            
            // é‡ç½®LumiçŠ¶æ€
            updateLumiReaction('welcome');
            
            // é‡æ–°åŠ è½½é”™è¯ç»Ÿè®¡
            loadErrorStats();
        }

        // ä¸‹ä¸€æ­¥æŒ‰é’®å’Œå›è½¦é”®
        nextBtn.addEventListener('click', function() {
            if (inputEnabled) {
                handleNextQuestion();
            }
        });

        toggleDetailsBtn.addEventListener('click', () => {
            if (wordDetailsContainer.style.display === 'none') {
                wordDetailsContainer.style.display = 'block';
                toggleDetailsBtn.textContent = 'éšè—æ›´å¤šè¯¦æƒ…';
                
                // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥è¯¦æƒ…å†…å®¹æ˜¯å¦ä¸ºç©º
                const detailsContent = [
                    document.getElementById('question-derivatives').textContent,
                    document.getElementById('question-root-etymology').textContent,
                    document.getElementById('question-mnemonic').textContent,
                    document.getElementById('question-comparison').textContent,
                    document.getElementById('question-collocation').textContent,
                    document.getElementById('question-exam-sentence').textContent,
                    document.getElementById('question-exam-year-source').textContent,
                    document.getElementById('question-exam-options').textContent,
                    document.getElementById('question-exam-explanation').textContent,
                    document.getElementById('question-tips').textContent
                ];
                
                const hasContent = detailsContent.some(text => text.trim() !== '');
                if (!hasContent) {
                    // å¦‚æœæ‰€æœ‰è¯¦æƒ…å†…å®¹éƒ½ä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                    const noContentMsg = document.createElement('p');
                    noContentMsg.id = 'no-details-msg';
                    noContentMsg.textContent = 'å½“å‰å•è¯æ²¡æœ‰æ›´å¤šè¯¦ç»†ä¿¡æ¯';
                    noContentMsg.style.color = '#888';
                    noContentMsg.style.fontStyle = 'italic';
                    noContentMsg.style.textAlign = 'center';
                    noContentMsg.style.padding = '10px';
                    
                    // æ¸…é™¤ä¹‹å‰çš„æç¤ºï¼ˆå¦‚æœæœ‰ï¼‰
                    const oldMsg = document.getElementById('no-details-msg');
                    if (oldMsg) oldMsg.remove();
                    
                    wordDetailsContainer.appendChild(noContentMsg);
                }
            } else {
                wordDetailsContainer.style.display = 'none';
                toggleDetailsBtn.textContent = 'æ˜¾ç¤ºæ›´å¤šè¯¦æƒ…';
            }
        });
        answerInput.addEventListener('keydown', function(event) {
            if (event.keyCode === 13 && inputEnabled) {
                event.preventDefault();
                handleNextQuestion();
            }
        });
    </script>
<script src="/fix_mess_display_new.js"></script>
</body>
</html>